<!DOCTYPE html>
<html>




<!--العنوان الرئيسى للصفحة-->
<Head>
    <Title id="water quality monitoring">Water Quality Monitoring</Title>
    <link rel="stylesheet" href="Water_ Quality.css">

</Head>



<body>
    <!-- المستخدم وعنوان الصفحة-->
<div class="username">
    <label for="username" class="dislabel" type="label">Email</label>
    <input id="username" value="" disabled> 
   
</div>
<div class="region">
    <label for="section" class="dislabel" type="label">Section</label>
    <input id="section" value="" disabled> 
   
</div>

<br>
<br>
    <h1>Water Quality Monitoring</h1>




                    <!--Water qyality form-->
<form>
    <!--البيانات الاساسية-->
    <div class="essdata">
    <label class="dat" for="date">Date</label>
    <input id="date" type="date" required>

    <label class="dat"for="markz">Branch</label>
    <select id="markz" type="optgroup" required> 
            <option value="" disabled selected>Branch</option>
            <option value="العدوه">العدوه</option>
            <option value="مغاغة">مغاغة</option>
            <option value="بنى مزار">بنى مزار</option>
            <option value="مطاى">مطاى</option>
            <option value="سمالوط">سمالوط</option>
            <option value="المنيا">المنيا</option>
            <option value="ابوقرقاص">ابوقرقاص</option>
            <option value="ملوى">ملوى</option>
            <option value="ديرمواس">ديرمواس</option>
    </select>
        
    <label class="dat" for="station">Station</label>
    <select id="station" value="" type="select"><option value="" disabled selected></option></select>

    <label class="dat" for="sample">Location</label>
    <input id="sample" value="المأخذ" type="location" readonly>
    <input type="hidden" id="entry-id">


    
    </div>
    <hr>

  
       
        <input id="physical" type="radio" name="para" checked>
        <label for="physical" class="para-label" >Physical parameters</label>

        
        <input id="chemical" type="radio" name="para">
        <label for="chemical" class="para-label">Chemical parameters</label>

        <input id="biological" type="radio" name="para">
        <label for="biological" class="para-label">Biological parameters</label>
    
               <!--التحاليل الفيزيائية-->

    <div class="contents">
        <div class="content" id="physical-content">

            <label for="turbidity">Turbidity NTU</label>
            <input id="turbidity" name="turbidity" type="number">
            
            <label for="pH">pH</label>
            <input id="pH" name="pH" type="number">

            <label for="temp">Temp <sup>o</sup>C</label>
            <input id="temp" name="temp" type="number">
       
                        <!--التحاليل الكيميائية-->
        </div>
        <div class="content" id="chemical-content">

            <label for="tds">TDS mg/l</label>
            <input id="tds" name="tds" type="number">

            <label for="ch">Chlorides mg/l</label>
            <input id="ch" name="ch" type="number">

            <label for="sulf">Sulfates mg/l</label>
            <input id="sulf" name="sulf" type="number">

            <label for="fe">Fe mg/l</label>
            <input id="fe" name="fe" type="number">

            <label for="mn">Mn mg/l</label>
            <input id="mn" name="mn" type="number">

            <label for="nh3">NH<sub>3</sub> mg/l</label>
            <input id="nh3" name="nh3" type="number">

            <label for="no2">NO<sub>2</sub> mg/l</label>
            <input id="no2" name="no2" type="number">

            <label for="no3">NO<sub>3</sub> mg/l</label>
            <input id="no3" name="no3" type="number">

            <label for="do">DO mg/l</label>
            <input id="do" name="do" type="number">

            <label for="cod">COD mg/l</label>
            <input id="cod" name="cod" type="number">

            <label for="bod">BOD mg/l</label>
            <input id="bod" name="bod" type="number">

            <label for="og">Oil & Grease mg/l</label>
            <input id="og" name="og" type="number">

           
        </div>

            <!--التحاليل البيولوجية والميكروبيولوجية-->
        <div class="content" id="biological-content">
            <label for="tc">Total Coliform C.U.F/100 ml</label>
            <input id="tc" name="tc" type="number">

            <label for="ta">Total Algae Colony/100 ml</label>
            <input id="ta" name="ta" type="number">

        </div>
    </div> 
    <br>
    <br>
    

    <div class="buttons">
        <button class="button-content">Submit</button>
        
        <button class="button-content">Update</button>
        
        <button class="button-content">Delete</button>
        
    </div>
    <br><br><br><br><br><br><br>

    <table class="table-data">
        <thead class="thead">
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Markz</th>
              <th>location</th>
              <th>Turbidity</th>
              <th>pH</th>
              <th>Temp</th>
              <th>TDS</th>
              <th>Chlorides</th>
              <th>Sulfates</th>
              <th>Fe</th>
              <th>Mn</th>
              <th>NH<sub>3</sub></th>
              <th>NO<sub>2</sub></th>
              <th>NO<sub>3</sub></th>
              <th>DO</th>
              <th>COD</th>
              <th>BOD</th>
              <th>Oil&Grease</th>
              <th>Total Coliform</th>
              <th>Total Algae</th>
              
            </tr>
        </thead>
        <tbody>
            <tr> </tr>
        </tbody>
       
    </table>
   

</form>
</body> 
</html>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";

// تحميل البيانات عند فتح الصفحة
window.onload = () => {
  const email = sessionStorage.getItem("email");
  const department = sessionStorage.getItem("department");

  if (!email || !department) {
    alert("يرجى تسجيل الدخول أولاً");
    window.location = "login.html";
    return;
  }

  document.getElementById("username").value = email;
  document.getElementById("section").value = department;
    
//عدم فاعلية branch فى حالة الدخول اى منطقة عدا WSP
  if (department !== "WSP"){  
  // تحديد قيمة الـ select تلقائياً بناءً على القسم
  document.getElementById("markz").value = department;
  document.getElementById("markz").disabled = true;
  } 
  fetchData(email, department);
};

function fetchData(email, department) {
  fetch(`${scriptURL}?action=getData&email=${encodeURIComponent(email)}&department=${encodeURIComponent(department)}`)
    .then(response => response.json())
    .then(data => {
      if (data.status === "unauthorized") {
        alert("غير مصرح لك بالوصول");
        return;
      }

      const rows = data.water_data;
      const tbody = document.querySelector("table.table-data tbody");
      tbody.innerHTML = "";

      const desiredColumnIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];

      rows.slice(1).forEach((row) => {
        const rowMarkz = row[2]; // العمود الثالث هو "Markz"
       // إذا كان المستخدم ليس من WSP، تجاهل الصف إذا لم يكن من نفس القسم
        if (department !== "WSP" && rowMarkz !== department) return;


        const tr = document.createElement("tr");

        row.forEach((cell, index) => {
          if (desiredColumnIndexes.includes(index)) {
            const td = document.createElement("td");
            td.textContent = cell ?? "";
            tr.appendChild(td);
          }
        });

        tr.addEventListener("click", () => {
          clearRowHighlight();
          tr.classList.add("selected-row");
          fillFormWithRow(row);
        });

        tbody.appendChild(tr);
      });

      // إذا لم توجد بيانات
      if (!tbody.hasChildNodes()) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = desiredColumnIndexes.length;
        td.textContent = "لا توجد بيانات لعرضها لهذه المنطقة.";
        td.style.textAlign = "center";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    })
    .catch(error => {
      console.error("خطأ:", error);
      alert("حدث خطأ أثناء تحميل البيانات.");
    });
}


function fillFormWithRow(row) {
  const isoDate = new Date(row[1]);
  const formattedDate = isoDate.toISOString().split("T")[0];
  document.getElementById("entry-id").value = row[0];
  document.getElementById("date").value = formattedDate;
  document.getElementById("markz").value = row[2];
  document.getElementById("sample").value = row[3];
  document.getElementById("turbidity").value = row[4];
  document.getElementById("pH").value = row[5];
  document.getElementById("temp").value = row[6];
  document.getElementById("tds").value = row[7];
  document.getElementById("ch").value = row[8];
  document.getElementById("sulf").value = row[9];
  document.getElementById("fe").value = row[10];
  document.getElementById("mn").value = row[11];
  document.getElementById("nh3").value = row[12];
  document.getElementById("no2").value = row[13];
  document.getElementById("no3").value = row[14];
  document.getElementById("do").value = row[15];
  document.getElementById("cod").value = row[16];
  document.getElementById("bod").value = row[17];
  document.getElementById("og").value = row[18];
  document.getElementById("tc").value = row[19];
  document.getElementById("ta").value = row[20];
}

function clearRowHighlight() {
  document.querySelectorAll("table.table-data tr").forEach(row => row.classList.remove("selected-row"));
}

document.querySelectorAll(".button-content")[0].addEventListener("click", function (e) {
  e.preventDefault();
  sendData("add");
});

document.querySelectorAll(".button-content")[1].addEventListener("click", function (e) {
  e.preventDefault();
  sendData("update");
});

document.querySelectorAll(".button-content")[2].addEventListener("click", function (e) {
  e.preventDefault();
  sendData("delete");
});

function sendData(action) {
  const email = sessionStorage.getItem("email");
  const department = sessionStorage.getItem("department");

  const formData = new URLSearchParams();

  formData.append("action", action);
  formData.append("email", email);
  formData.append("department", department);
  formData.append("id", document.getElementById("entry-id").value);
  formData.append("date", document.getElementById("date").value);
  formData.append("markz", document.getElementById("markz").value);
  formData.append("location", document.getElementById("sample").value);
  formData.append("turbidity", document.getElementById("turbidity").value);
  formData.append("ph", document.getElementById("pH").value);
  formData.append("temp", document.getElementById("temp").value);
  formData.append("tds", document.getElementById("tds").value);
  formData.append("chlorides", document.getElementById("ch").value);
  formData.append("sulfates", document.getElementById("sulf").value);
  formData.append("fe", document.getElementById("fe").value);
  formData.append("mn", document.getElementById("mn").value);
  formData.append("nh3", document.getElementById("nh3").value);
  formData.append("no2", document.getElementById("no2").value);
  formData.append("no3", document.getElementById("no3").value);
  formData.append("do", document.getElementById("do").value);
  formData.append("cod", document.getElementById("cod").value);
  formData.append("bod", document.getElementById("bod").value);
  formData.append("og", document.getElementById("og").value);
  formData.append("tc", document.getElementById("tc").value);
  formData.append("ta", document.getElementById("ta").value);

  fetch(scriptURL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: formData.toString()
  })
    .then(response => response.text())
    .then(result => {
      alert(`تمت عملية ${action === 'add' ? 'الإضافة' : action === 'update' ? 'التحديث' : 'الحذف'} بنجاح.`);
      clearForm();
      fetchData(email, department);
    })
    .catch(error => {
      console.error("خطأ:", error);
      alert("حدث خطأ أثناء تنفيذ العملية.");
    });
}

function clearForm() {
  document.querySelector("form").reset();
  document.getElementById("entry-id").value = "";
  clearRowHighlight();
}

</script>






































































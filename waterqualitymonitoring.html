<!DOCTYPE html>
<html>


<!--العنوان الرئيسى للصفحة-->
<head>
    <title >RWater Quality Monitoring</title>
    <link rel="stylesheet" href="Water_Quality.css">

</head>



<body>
    <!-- المستخدم وعنوان الصفحة-->
<div class="username">
    <label for="username" class="dislabel" type="label">Email</label>
    <input id="username" value="" disabled> 
   
</div>
<div class="region">
    <label for="section" class="dislabel" type="label">Section</label>
    <input id="section" value="" disabled> 
   
</div>

<br>
<br>
    <h1>Raw Water Quality Monitoring</h1>




                    <!--Water qyality form-->
<form>
    <!--البيانات الاساسية-->
    <div class="essdata">
    <label class="dat" for="date">Date</label>
    <input id="date" type="date" required>

    <label class="dat"for="branch">Branch</label>
    <select id="branch" type="select" required>                      
            <option value="" disabled selected>Select Branch</option> 
            <option value="العدوه">العدوه</option>
            <option value="مغاغة">مغاغة</option>
            <option value="بنى مزار">بنى مزار</option>
            <option value="مطاى">مطاى</option>
            <option value="سمالوط">سمالوط</option>
            <option value="المنيا">المنيا</option>
            <option value="ابوقرقاص">ابوقرقاص</option>
            <option value="ملوى">ملوى</option>
            <option value="ديرمواس">ديرمواس</option>
    </select>
        
    <label class="dat" for="station">Station</label>
    <select id="station" value="" type="select"><option>Select Staion</option></select> 

    <label class="dat" for="sample">Location</label>
    <input id="sample" value="المأخذ" type="location" readonly>
    
    <input type="hidden" id="entry-id">


    
    </div>
    <hr>

  
       
        <input id="physical" type="radio" name="para" checked>
        <label for="physical" class="para-label" >Physical parameters</label>

        
        <input id="chemical" type="radio" name="para">
        <label for="chemical" class="para-label">Chemical parameters</label>

        <input id="biological" type="radio" name="para">
        <label for="biological" class="para-label">Biological parameters</label>
    
               <!--التحاليل الفيزيائية-->

    <div class="contents">
        <div class="content" id="physical-content">

            <label for="turbidity">Turbidity NTU</label>
            <input id="turbidity" name="turbidity" type="number">
            
            <label for="pH">pH</label>
            <input id="pH" name="pH" type="number">

            <label for="temp">Temp <sup>o</sup>C</label>
            <input id="temp" name="temp" type="number">
       
                        <!--التحاليل الكيميائية-->
        </div>
        <div class="content" id="chemical-content">
          
            <label for="tds">TDS mg/l</label>
            <input id="tds" name="tds" type="number">

            <label for="ch">Chlorides mg/l</label>
            <input id="ch" name="ch" type="number">

            <label for="sulf">Sulfates mg/l</label>
            <input id="sulf" name="sulf" type="number">

            <label for="fe">Fe mg/l</label>
            <input id="fe" name="fe" type="number">

            <label for="mn">Mn mg/l</label>
            <input id="mn" name="mn" type="number">

            <label for="nh3">NH<sub>3</sub> mg/l</label>
            <input id="nh3" name="nh3" type="number">

         
            

   
            <label for="no2">NO<sub>2</sub> mg/l</label>
            <input id="no2" name="no2" type="number">

            <label for="no3">NO<sub>3</sub> mg/l</label>
            <input id="no3" name="no3" type="number">
                    
            <label for="do">DO mg/l</label>
            <input id="do" name="do" type="number">

            <label for="cod">COD mg/l</label>
            <input id="cod" name="cod" type="number">

            <label for="bod">BOD mg/l</label>
            <input id="bod" name="bod" type="number">

            <label for="og">Oil & Grease mg/l</label>
            <input id="og" name="og" type="number">

            
        </div>

            <!--التحاليل البيولوجية والميكروبيولوجية-->
        <div class="content" id="biological-content">
            <label for="tc">Total Coliform C.U.F/100 ml</label>
            <input id="tc" name="tc" type="number">

            <label for="ta">Total Algae Colony/100 ml</label>
            <input id="ta" name="ta" type="number">

        </div>
    </div> 
    <br>
    <br>
    

    <div class="buttons">
        <button class="button-content">Submit</button>
        
        <button class="button-content">Update</button>
        
        <button class="button-content">Delete</button>
        
    </div>
    <br><br><br><br><br><br><br>
    <div>
        <button onclick="printTable()" class="output">
            <img src="https://static.vecteezy.com/system/resources/previews/006/693/009/non_2x/printer-icon-template-black-color-editable-printer-icon-symbol-flat-illustration-for-graphic-and-web-design-free-vector.jpg" alt="print">
        </button>
    
        <button onclick="exportTableToExcel('waterqualitytable', 'water_quality_data')" class="output">
            <img src="https://static.vecteezy.com/system/resources/previews/017/396/828/non_2x/microsoft-excel-mobile-apps-logo-free-png.png" alt="export">
        </button>
    </div>
    
    <table id = "waterqualitytable" class="table-data">
        <thead class="thead">
            <tr>
              
              <th>Date</th>
              <th>Branch</th> <!--تعديل السطر-->
              <th>Station</th> <!--اضافة سطر-->
              <th>location</th>
              <th>Turbidity</th>
              <th>pH</th>
              <th>Temp</th>
              <th>TDS</th>
              <th>Chlorides</th>
              <th>Sulfates</th>
              <th>Fe</th>
              <th>Mn</th>
              <th>NH<sub>3</sub></th>
              <th>NO<sub>2</sub></th>
              <th>NO<sub>3</sub></th>
              <th>DO</th>
              <th>COD</th>
              <th>BOD</th>
              <th>Oil&Grease</th>
              <th>Total Coliform</th>
              <th>Total Algae</th>
              
            </tr>
        </thead>
        <tbody>
            <tr>
              <td></td> 
            </tr>
        </tbody>
       
    </table>
   

</form>
</body> 
</html>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";
    
// تعريف متغيرات عامة
let department = "";

// يتم تنفيذ هذا الكود عند تحميل الصفحة بالكامل
window.onload = () => {
  // جلب البريد الإلكتروني والقسم من الجلسة (sessionStorage)
  const email = sessionStorage.getItem("email");
  department = sessionStorage.getItem("department");

  // الحصول على عناصر الـ select الخاصة بالمحطة والفرع
  const stationSelect = document.getElementById("station");
  const branchSelect = document.getElementById("branch");

  // التحقق من وجود بيانات الدخول، إذا لم تكن موجودة يتم توجيه المستخدم إلى صفحة تسجيل الدخول
  if (!email || !department) {
    alert("يرجى تسجيل الدخول أولاً");
    window.location = "login.html";
    return;
  }

  // تعبئة البريد الإلكتروني والقسم في الحقول الخاصة بهما
  document.getElementById("username").value = email;
  document.getElementById("section").value = department;

  // إذا لم يكن المستخدم من قسم WSP
  if (department !== "WSP") {
    // يتم تعيين الفرع تلقائيًا من القسم وتعطيل إمكانية تغييره
    branchSelect.value = department;
    branchSelect.disabled = true;

    // جلب قائمة المحطات الخاصة بالفرع من Google App Script
    fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(department)}`)
      .then(response => response.json()) // تحويل الاستجابة إلى JSON
      .then(data => {
        // عرض رسالة مؤقتة أثناء تحميل المحطات
        stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
        
        // إذا تم جلب المحطات بنجاح
        if (data.status === "success") {
          // إعادة تعيين القائمة
          stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
          
          // إضافة كل محطة كخيار في القائمة
          data.stations.forEach(station => {
            const option = document.createElement("option");
            option.value = station;
            option.textContent = station;
            stationSelect.appendChild(option);
          });
        } else {
          // في حال عدم وجود محطات
          stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
        }
      })
      .catch(error => {
        // في حال حدوث خطأ أثناء الاتصال
        console.error("Error fetching stations:", error);
        stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
      });

  } else {
    // إذا كان المستخدم من قسم WSP (أي يمكنه اختيار أي فرع)
    
    // إتاحة اختيار الفرع من القائمة
    branchSelect.disabled = false;

    // عند تغيير الفرع المختار من قبل المستخدم
    branchSelect.addEventListener("change", () => {
      const selectedBranch = branchSelect.value; // الحصول على الفرع المختار
      if (!selectedBranch) return; // التأكد من أن قيمة الفرع صالحة

      // عرض رسالة تحميل مؤقتة
      stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';

      // إرسال طلب لجلب المحطات الخاصة بالفرع المختار
      fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(selectedBranch)}`)
        .then(response => response.json()) // تحويل الاستجابة إلى JSON
        .then(data => {
          if (data.status === "success") {
            // تفريغ وإعادة بناء القائمة بالمحطات الجديدة
            stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
            data.stations.forEach(station => {
              const option = document.createElement("option");
              option.value = station;
              option.textContent = station;
              stationSelect.appendChild(option);
            });
          } else {
            // في حال لم يتم العثور على محطات
            stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
          }
        })
        .catch(error => {
          // في حال حدوث خطأ أثناء الاتصال
          console.error("Error fetching stations:", error);
          stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
        });
    });
  }

  // تحميل البيانات الخاصة بجودة المياه للمستخدم أو القسم
  fetchData(email, department);
};

function fetchData(email, department) {
  fetch(`${scriptURL}?action=getData&email=${encodeURIComponent(email)}&department=${encodeURIComponent(department)}`)
    .then(response => response.json())
    .then(data => {
      if (data.status === "unauthorized") {
        alert("غير مصرح لك بالوصول");
        return;
      }

      const rows = data.water_data;
      const tbody = document.querySelector("table.table-data tbody");
      tbody.innerHTML = "";

      const desiredColumnIndexes = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21];

      rows.slice(1).forEach((row) => {
        const rowBranch = row[2]; // العمود الثالث هو "Branch"
        if (department !== "WSP" && rowBranch !== department) return;

        const tr = document.createElement("tr");

        row.forEach((cell, index) => {
          if (desiredColumnIndexes.includes(index)) {
            const td = document.createElement("td");

            if (index === 1) {
              const d = new Date(cell);
              td.textContent = !isNaN(d.getTime())
                ? `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`
                : cell ?? "";
            } else {
              td.textContent = cell ?? "";
            }

            tr.appendChild(td);
          }
        });
        tr.addEventListener("click", () => {
          clearRowHighlight();
          tr.classList.add("selected-row");
          fillFormWithRow(row);
        });
        tbody.appendChild(tr);
      });

      // إذا لم توجد بيانات
      if (!tbody.hasChildNodes()) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = desiredColumnIndexes.length;
        td.textContent = "لا توجد بيانات لعرضها لهذه المنطقة.";
        td.style.textAlign = "center";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    })
    .catch(error => {
      console.error("خطأ:", error);
      alert("حدث خطأ أثناء تحميل البيانات.");
    });
}

function formatDateForInput(dateValue) {
  try {
    const d = new Date(dateValue);
    if (isNaN(d.getTime())) return "";

    // استخدام toLocaleDateString لضمان تحويل التاريخ إلى توقيت مصر
    const [day, month, year] = d
      .toLocaleDateString("en-GB", { timeZone: "Africa/Cairo" })
      .split("/");

    return `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
  } catch (error) {
    console.error("Invalid date for input formatting:", error);
    return "";
  }
}

function fillFormWithRow(row) {
  console.log("Row data:", row); // تحقق من البيانات المستخلصة من الصف

  const formattedDate = formatDateForInput(row[1]); // تنسيق التاريخ
  document.getElementById("date").value = formattedDate; // تعبئة الحقل بالتاريخ المنسق

  document.getElementById("entry-id").value = row[0]; // تعبئة ID
    // تعبئة الفرع
  document.getElementById("branch").value = row[2];

  // إذا كان المستخدم WSP، نحتاج إلى تحميل المحطات الخاصة بالفرع المختار من الصف
  if (department === "WSP") {
    // جلب المحطات الخاصة بالفرع
    fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(row[2])}`)
      .then(response => response.json())
      .then(data => {
        const stationSelect = document.getElementById("station");
        stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';

        if (data.status === "success") {
          data.stations.forEach(station => {
            const option = document.createElement("option");
            option.value = station;
            option.textContent = station;
            stationSelect.appendChild(option);
          });

          // بعد تحميل المحطات، نضبط المحطة بناءً على قيمة الصف
          stationSelect.value = row[3];
        } else {
          stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
        }
      })
      .catch(error => {
        console.error("Error fetching stations:", error);
        document.getElementById("station").innerHTML = '<option value="" disabled selected>Connection Error</option>';
      });
  } else {
    // إذا لم يكن WSP، فقط عين المحطة مباشرة
    document.getElementById("station").value = row[3];
  }

  document.getElementById("branch").value = row[2]; // تعبئة الفرع
  document.getElementById("station").value = row[3]; // تعبئة المحطة
  document.getElementById("sample").value = row[4]; // تعبئة الموقع

  // تعبئة باقي الحقول
  document.getElementById("turbidity").value = row[5];
  document.getElementById("pH").value = row[6];
  document.getElementById("temp").value = row[7];
  document.getElementById("tds").value = row[8];
  document.getElementById("ch").value = row[9];
  document.getElementById("sulf").value = row[10];
  document.getElementById("fe").value = row[11];
  document.getElementById("mn").value = row[12];
  document.getElementById("nh3").value = row[13];
  document.getElementById("no2").value = row[14];
  document.getElementById("no3").value = row[15];
  document.getElementById("do").value = row[16];
  document.getElementById("cod").value = row[17];
  document.getElementById("bod").value = row[18];
  document.getElementById("og").value = row[19];
  document.getElementById("tc").value = row[20];
  document.getElementById("ta").value = row[21];
}

function clearRowHighlight() {
  document.querySelectorAll("table.table-data tr").forEach(row => {
    row.classList.remove("selected-row");
  });
}

// إضافة حدث لتحديد الصف وتعبئة البيانات
document.querySelectorAll("table.table-data tr").forEach(row => {
  row.addEventListener("click", function() {
    console.log("Row selected:", row);
    clearRowHighlight(); // إزالة التمييز عن الصفوف الأخرى
    row.classList.add("selected-row"); // تمييز الصف الحالي
    const rowData = Array.from(row.children).map(td => td.textContent); // جمع البيانات من جميع خلايا الصف
    fillFormWithRow(rowData); // تعبئة النموذج باستخدام بيانات الصف
  });
});
document.querySelectorAll(".button-content")[0].addEventListener("click", function (e) {
  e.preventDefault();
  sendData("add");
});

document.querySelectorAll(".button-content")[1].addEventListener("click", function (e) {
  e.preventDefault();
  sendData("update");
});

document.querySelectorAll(".button-content")[2].addEventListener("click", function (e) {
  e.preventDefault();
  sendData("delete");
});

    
function sendData(action) {
  const email = sessionStorage.getItem("email");
  const department = sessionStorage.getItem("department");

  if ((action === "update" || action === "delete") && !document.getElementById("entry-id").value) {
    alert("يرجى اختيار صف من الجدول قبل التحديث أو الحذف.");
    return;
  }

  const formData = new URLSearchParams();
  formData.append("action", action);
  formData.append("email", email);
  formData.append("department", department);
  formData.append("id", document.getElementById("entry-id").value);
  formData.append("date", document.getElementById("date").value);
  formData.append("branch", document.getElementById("branch").value);
  formData.append("station", document.getElementById("station").value);
  formData.append("location", document.getElementById("sample").value);
  formData.append("turbidity", document.getElementById("turbidity").value);
  formData.append("ph", document.getElementById("pH").value);
  formData.append("temp", document.getElementById("temp").value);
  formData.append("tds", document.getElementById("tds").value);
  formData.append("chlorides", document.getElementById("ch").value);
  formData.append("sulfates", document.getElementById("sulf").value);
  formData.append("fe", document.getElementById("fe").value);
  formData.append("mn", document.getElementById("mn").value);
  formData.append("nh3", document.getElementById("nh3").value);
  formData.append("no2", document.getElementById("no2").value);
  formData.append("no3", document.getElementById("no3").value);
  formData.append("do", document.getElementById("do").value);
  formData.append("cod", document.getElementById("cod").value);
  formData.append("bod", document.getElementById("bod").value);
  formData.append("og", document.getElementById("og").value);
  formData.append("tc", document.getElementById("tc").value);
  formData.append("ta", document.getElementById("ta").value);

  fetch(scriptURL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: formData.toString()
  })
    .then(response => response.text())
    .then(result => {
      alert(`تمت عملية ${action === 'add' ? 'الإضافة' : action === 'update' ? 'التحديث' : 'الحذف'} بنجاح.`);
      clearForm();
      fetchData(email, department);
    })
    .catch(error => {
      console.error("خطأ:", error);
      alert("حدث خطأ أثناء تنفيذ العملية.");
    });
}

function clearForm() {
  document.querySelector("form").reset();
  document.getElementById("entry-id").value = "";
  clearRowHighlight();
  if (department !== "WSP") {
          // تحديد قيمة الـ select تلقائياً بناءً على القسم
          document.getElementById("branch").value = department;
          document.getElementById("branch").disabled = true;
          document.getElementById("station").innerHTML = '<option value="" disabled selected>Select Station</option>';
  }
  
}






    
function printTable() {
  const table = document.getElementById("waterqualitytable").outerHTML;
  const style = `
    <style>
      table { border-collapse: collapse; width: 100%; direction: ltr; }
      th, td { border: 1px solid #000; padding: 8px; text-align: center; }
    </style>
  `;
  const win = window.open('', '', 'height=700,width=900');
  win.document.write('<html><head><title>Raw Water Quality Monitoring</title>');
  win.document.write(style);
  win.document.write('</head><body>');
  win.document.write(table);
  win.document.write('</body></html>');
  win.document.close();
  win.print();
}
function exportTableToExcel(waterqualitytable, filename = '') {
  const table = document.getElementById(waterqualitytable);
  const dataType = 'application/vnd.ms-excel';
  const tableHTML = table.outerHTML.replace(/ /g, '%20');

  const link = document.createElement("a");
  document.body.appendChild(link);

  filename = filename ? filename + '.xls' : 'excel_data.xls';
  link.href = 'data:' + dataType + ', ' + tableHTML;
  link.download = filename;
  link.click();
  document.body.removeChild(link);
}


</script>


















































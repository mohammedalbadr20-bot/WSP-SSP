<!DOCTYPE html>
  <html>
<!--Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©-->
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title >Raw Water Quality Monitoring</title>
      <link rel="stylesheet" href="Water_Quality.css">
    </head>
    <body>
          <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¹Ù†ÙˆØ§Ù† -->
      <div class="username">
          <label for="username" class="dislabel" type="label">Email</label>
          <input id="username" value="" disabled> 
      </div>
      <div class="region">
          <label for="section" class="dislabel" type="label">Section</label>
          <input id="section" value="" disabled> 
         
      </div>
      
      <br>
      <br>
      <h1>Water Quality Monitoring</h1>
    
                        <!--Raw Water qyality form-->
    <form>
      <!-- Ø§Ù„Ø§Ø³Ø§Ø³ÙŠØ©-->
      <div class="essdata">
        <label class="dat" for="date">Date</label>
        <input id="date" type="date" required>
    
        <label class="dat"for="branch">Branch</label>
        <select id="branch" type="select"> 
                <option value="" disabled selected>Select Branch</option>
                <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
                <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
                <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
                <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
                <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
                <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
                <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
                <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
                <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
        </select>
            
        <label class="dat" for="station">Station</label>
        <select id="station" value="" type="select">
        </select>
    
        <label class="dat" for="sample">Location</label>
        <input id="sample" value="Ø§Ù„Ù…Ø£Ø®Ø°" type="location" readonly>
      
        <input type="hidden" id="entry-id">
       
      </div>
      <hr>
    
        <input id="physical" type="radio" name="para" checked>
        <label for="physical" class="para-label" >Physical parameters</label>
        
        <input id="chemical" type="radio" name="para">
        <label for="chemical" class="para-label">Chemical parameters</label>
    
        <input id="biological" type="radio" name="para">
        <label for="biological" class="para-label">Biological parameters</label>
        
                   <!--Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©-->
    
        <div class="contents">
            <div class="content" id="physical-content">
    
                <label for="turbidity">Turbidity NTU</label>
                <input id="turbidity" name="turbidity" type="number">
                
                <label for="pH">pH</label>
                <input id="pH" name="pH" type="number">
    
                <label for="temp">Temp <sup>o</sup>C</label>
                <input id="temp" name="temp" type="number">
           
                            <!--Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©-->
            </div>
            <div class="content" id="chemical-content">
    
                <label for="tds">TDS mg/l</label>
                <input id="tds" name="tds" type="number">
    
                <label for="ch">Chlorides mg/l</label>
                <input id="ch" name="ch" type="number">
    
                <label for="sulf">Sulfates mg/l</label>
                <input id="sulf" name="sulf" type="number">
    
                <label for="fe">Fe mg/l</label>
                <input id="fe" name="fe" type="number">
    
                <label for="mn">Mn mg/l</label>
                <input id="mn" name="mn" type="number">
    
                <label for="nh3">NH<sub>3</sub> mg/l</label>
                <input id="nh3" name="nh3" type="number">
    
                <label for="no2">NO<sub>2</sub> mg/l</label>
                <input id="no2" name="no2" type="number">
    
                <label for="no3">NO<sub>3</sub> mg/l</label>
                <input id="no3" name="no3" type="number">
    
                <label for="do">DO mg/l</label>
                <input id="do" name="do" type="number">
    
                <label for="cod">COD mg/l</label>
                <input id="cod" name="cod" type="number">
    
                <label for="bod">BOD mg/l</label>
                <input id="bod" name="bod" type="number">
    
                <label for="og">Oil & Grease mg/l</label>
                <input id="og" name="og" type="number">
      
            </div>
    
                <!--Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠÙˆÙ„ÙˆØ¬ÙŠØ© ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆØ¨ÙŠÙˆÙ„ÙˆØ¬ÙŠØ©-->
            <div class="content" id="biological-content">
                <label for="tc">Total Coliform C.U.F/100 ml</label>
                <input id="tc" name="tc" type="number">
    
                <label for="ta">Total Algae Colony/100 ml</label>
                <input id="ta" name="ta" type="number">
    
            </div>
        </div> 
        <br>
        <br>
        
        <div class="buttons">
            <button class="button-content">Submit</button>
            
            <button class="button-content">Update</button>
            
            <button class="button-content">Delete</button>
            
        </div>
        <br><br><br><br><br><br><br>
    
        <table class="table-data">
            <thead class="thead">
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th>Branch</th>
                  <th>Station</th>
                  <th>location</th>
                  <th>Turbidity</th>
                  <th>pH</th>
                  <th>Temp</th>
                  <th>TDS</th>
                  <th>Chlorides</th>
                  <th>Sulfates</th>
                  <th>Fe</th>
                  <th>Mn</th>
                  <th>NH<sub>3</sub></th>
                  <th>NO<sub>2</sub></th>
                  <th>NO<sub>3</sub></th>
                  <th>DO</th>
                  <th>COD</th>
                  <th>BOD</th>
                  <th>Oil&Grease</th>
                  <th>Total Coliform</th>
                  <th>Total Algae</th>
                  
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td></td>
                </tr>
            </tbody>
           
        </table>
       
    
    </form>
    <script>
      const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";
      window.onload = () => {
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department");
      if (!email || !department) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        window.location = "login.html";
        return;
      }
    
      document.getElementById("username").value = email;
      document.getElementById("section").value = department;
    
      const branchSelect = document.getElementById("branch");
      const stationSelect = document.getElementById("station");
    
      if (department !== "WSP") {
        document.getElementById("branch").value = department;
        document.getElementById("branch").disabled = true;
    
        fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(department)}`)
          .then(response => response.json())
          .then(data => {
            stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
            if (data.status === "success") {
              data.stations.forEach(station => {
                const option = document.createElement("option");
                option.value = station;
                option.textContent = station;
                stationSelect.appendChild(option);
              });
            } else {
              stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
            }
          })
          .catch(error => {
            console.error(" ÙÙŠ ØªØ­Ù…ÙŠÙ„ :", error);
            stationSelect.innerHTML = '<option value="" disabled selected>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</option>';
          });
      }
    
      // ğŸ‘‡ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ Ù‡Ø°Ø§ Ø¯Ø§Ø®Ù„ onload
      fetchData(email, department);
    };

       
      
      
      
      function fetchData(email, department) {
        fetch(`${scriptURL}?action=getData&email=${encodeURIComponent(email)}&department=${encodeURIComponent(department)}`)
          .then(response => response.json())
          .then(data => {
            if (data.status === "unauthorized") {
              alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„");
              return;
            }
      
            const rows = data.water_data;
            const tbody = document.querySelector("table.table-data tbody");
            tbody.innerHTML = "";
      
            const desiredColumnIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21];
      
            rows.slice(1).forEach((row) => {
              const rowBranch = row[2]; // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« Ù‡Ùˆ "Branch"
             // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù…Ù† WSPØŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù‚Ø³Ù…
              if (department !== "WSP" && rowBranch !== department) return;
      
      
              const tr = document.createElement("tr");
      
              row.forEach((cell, index) => {
                if (desiredColumnIndexes.includes(index)) {
                  const td = document.createElement("td");
                  td.textContent = cell ?? "";
                  tr.appendChild(td);
                }
              });
      
              tr.addEventListener("click", () => {
                clearRowHighlight();
                tr.classList.add("selected-row");
                fillFormWithRow(row);
              });
      
              tbody.appendChild(tr);
            });
      
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
            if (!tbody.hasChildNodes()) {
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = desiredColumnIndexes.length;
             td.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©";
              td.style.textAlign = "center";
              tr.appendChild(td);
              tbody.appendChild(tr);
            }
          })
          .catch(error => {
            console.error("Ø®Ø·Ø£:", error);
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
          });
      }
      
      
      function fillFormWithRow(row) {
        const isoDate = new Date(row[1]);
        const formattedDate = isoDate.toISOString().split("T")[0];
        document.getElementById("entry-id").value = row[0];
        document.getElementById("date").value = formattedDate;
        const branch = row[2];
        const station = row[3];
      
        const stationSelect = document.getElementById("station");
        const branchSelect = document.getElementById("branch");
      
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙØ±Ø¹ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙˆØ¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ Ø£Ø¶ÙÙ‡
        let branchOption = [...branchSelect.options].find(opt => opt.value === branch);
        if (!branchOption) {
            const newOption = document.createElement("option");
            newOption.value = branch;
            newOption.textContent = branch;
            branchSelect.appendChild(newOption);
        }
      
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø©
            branchSelect.value = branch;
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù…Ù† WSP
        if (department !== "WSP") {
            branchSelect.disabled = true;
        }
      
        //  Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
        stationSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
      
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰
        fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`)
          .then(response => response.json())
          .then(data => {
            if (data.status === "success") {
              stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
      
              data.stations.forEach(st => {
                const option = document.createElement("option");
                option.value = st;
                option.textContent = st;
                stationSelect.appendChild(option);
              });
      
              // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© station Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„Ù‡Ø§
              stationSelect.value = station;
            } else {
              stationSelect.innerHTML = '<option value="" disabled selected>Not Found</option>';
            }
          })
          .catch(error => {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø·Ø§Øª:", error);
            stationSelect.innerHTML = '<option value="" disabled selected>Error</option>';
          });
      
        document.getElementById("sample").value = row[4];
        document.getElementById("turbidity").value = row[5];
        document.getElementById("pH").value = row[6];
        document.getElementById("temp").value = row[7];
        document.getElementById("tds").value = row[8];
        document.getElementById("ch").value = row[9];
        document.getElementById("sulf").value = row[10];
        document.getElementById("fe").value = row[11];
        document.getElementById("mn").value = row[12];
        document.getElementById("nh3").value = row[13];
        document.getElementById("no2").value = row[14];
        document.getElementById("no3").value = row[15];
        document.getElementById("do").value = row[16];
        document.getElementById("cod").value = row[17];
        document.getElementById("bod").value = row[18];
        document.getElementById("og").value = row[19];
        document.getElementById("tc").value = row[20];
        document.getElementById("ta").value = row[21];
      }
      
      function clearRowHighlight() {
        document.querySelectorAll("table.table-data tr").forEach(row => row.classList.remove("selected-row"));
      }
      
      document.querySelectorAll(".button-content")[0].addEventListener("click", function (e) {
        e.preventDefault();
        sendData("add");
      });
      
      document.querySelectorAll(".button-content")[1].addEventListener("click", function (e) {
        e.preventDefault();
        sendData("update");
      });
      
      document.querySelectorAll(".button-content")[2].addEventListener("click", function (e) {
        e.preventDefault();
        sendData("delete");
      });
      
      function sendData(action) {
        const email = sessionStorage.getItem("email");
        const department = sessionStorage.getItem("department");
      
        const formData = new URLSearchParams();
      
        formData.append("action", action);
        formData.append("email", email);
        formData.append("department", department);
        formData.append("id", document.getElementById("entry-id").value);
        formData.append("date", document.getElementById("date").value);
        formData.append("branch", document.getElementById("branch").value);
        formData.append("station", document.getElementById("station").value);
        formData.append("location", document.getElementById("sample").value);
        formData.append("turbidity", document.getElementById("turbidity").value);
        formData.append("ph", document.getElementById("pH").value);
        formData.append("temp", document.getElementById("temp").value);
        formData.append("tds", document.getElementById("tds").value);
        formData.append("chlorides", document.getElementById("ch").value);
        formData.append("sulfates", document.getElementById("sulf").value);
        formData.append("fe", document.getElementById("fe").value);
        formData.append("mn", document.getElementById("mn").value);
        formData.append("nh3", document.getElementById("nh3").value);
        formData.append("no2", document.getElementById("no2").value);
        formData.append("no3", document.getElementById("no3").value);
        formData.append("do", document.getElementById("do").value);
        formData.append("cod", document.getElementById("cod").value);
        formData.append("bod", document.getElementById("bod").value);
        formData.append("og", document.getElementById("og").value);
        formData.append("tc", document.getElementById("tc").value);
        formData.append("ta", document.getElementById("ta").value);
      
        fetch(scriptURL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: formData.toString()
        })
        .then(response => response.text())
        .then(result => {
          alert(`ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© ${action === 'add' ? 'Ø§Ù„Ø¥Ø¶Ø§ÙØ©' : action === 'update' ? 'Ø§Ù„ØªØ­Ø¯ÙŠØ«' : 'Ø§Ù„Ø­Ø°Ù'} Ø¨Ù†Ø¬Ø§Ø­.`);
          clearForm();
          fetchData(email, department);
        })
        .catch(error => {
          console.error("Ø®Ø·Ø£:", error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
        });
        if (action === "delete" && !document.getElementById("entry-id").value) {
          alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¬Ù„ Ù„Ø­Ø°ÙÙ‡ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
        }
      }
    }
      
      function clearForm() {
        document.querySelector("form").reset();
        document.getElementById("entry-id").value = "";
        if (department !== "WSP") {
          // ØªØ­Ø¯ÙŠØ¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù€ select ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù…
          document.getElementById("branch").value = department;
          document.getElementById("branch").disabled = true;
          document.getElementById("station").innerHTML = '<option value="" disabled selected>Select Station</option>';
                         
        clearRowHighlight();
      }
          // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹ØŒ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ù…Ù† Google Sheets
        document.getElementById("branch").addEventListener("change", function () {
        const branch = this.value;
        const stationSelect = document.getElementById("station");
      
        // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        stationSelect.innerHTML = '<option value="" disabled selected>ÙSelect Station</option>';
      
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Google Apps Script Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙØ±Ø¹
        fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`)
          .then(response => response.json())
          .then(data => {
            if (data.status !== "success") {
              stationSelect.innerHTML = '<option value="" disabled selected>Not found stations</option>';
              return;
            }
      
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
            data.stations.forEach(station => {
              const option = document.createElement("option");
              option.value = station;
              option.textContent = station;
              stationSelect.appendChild(option);
            });
          })
          .catch(error => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª:", error);
            stationSelect.innerHTML = '<option value="" disabled selected>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</option>';
          });
      });
      

    </script>

  </body> 
</html>









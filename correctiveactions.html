<!DOCTYPE html>
<html>
<head>
  <title>Corrective Actions</title>
  <link rel="stylesheet" href="corr_action.css" />
</head>
<body>
  <div class="username">
    <label for="email" class="dislabel">Email</label>
    <input id="email" value="" disabled>
  </div>

  <div class="region">
    <label for="section" class="dislabel">Section</label>
    <input id="section" value="" disabled>
  </div>

  <form onsubmit="return false;">
    <h1>Corrective Actions</h1>
    <br><br>

    <div class="generalinfo">
      <div>
        <label class="infolabel">Branch</label>
        <select id="branch">
          <option value="" selected disabled>Select Branch</option>
          <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
          <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
          <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
          <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
          <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
          <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
          <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
          <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
          <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
        </select>
      </div>

      <div>
        <label class="infolabel">Station</label>
        <select id="station">
          <option value="" selected disabled>Select Station</option>
        </select>
      </div>

      <div>
        <label class="infolabel">Certified Date</label>
        <input type="date" id="certifieddate" readonly>
      </div>
    </div>

    <hr>
    
    <div class="location">
      <label>Location</label>
      <select id="location">
        <option value="">Select Location</option>
      </select>
    </div>

    <div class="risk">
      <label>Risk</label>
      <input value="" readonly id="risk"> 
    </div>

    <div class="action">
      <label>Corrective Action</label>
      <input value="" readonly id="action">
    </div>

    <div class="branchresponse">
      <div class="duration">
        <label>Duration (month)</label>
        <input type="number" value="" readonly id="duration">
      </div>

      <div>
        <label>Status</label>
        <select id="status">
          <option value="" selected disabled>Select Status</option>
          <option value="ØªÙ…">ØªÙ…</option>
          <option value="Ø¬Ø§Ø±Ù‰">Ø¬Ø§Ø±Ù‰</option>
          <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
        </select>
      </div>

      <div>
        <label>Attachment</label>
        <input id="attachment" type="file" accept="image/*">
        <span id="filename" style="margin-left:10px; color:#555;"></span>
      </div>
    </div>

    <div class="branchremark">
      <label>Branch Comment</label>
      <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
    </div>

    <div class="wspcomment">
      <label>WSP Comment</label>
      <textarea id="wspcomment" name="WSP Comments" maxlength="150"></textarea>
    </div>

    <hr>

    <div class="buttons">
      <button class="wspbutton" onclick="updateWSP()">WSP Submit</button>
      <button class="branchbutton" onclick="updateBranch()">Branch Submit</button>
    </div>
   
  </form>
  <script>
    const proxyURL = "https://wsp-ssp-gyzx.vercel.app/api/proxy";  // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ
    const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";
    ///
  
    window.onload = () => {
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department");
  
      document.getElementById("email").value = email || "";
      document.getElementById("section").value = department || "";
  
      const stationSelect = document.getElementById("station");
      const branchSelect = document.getElementById("branch");
      const certifiedDateInput = document.getElementById("certifieddate");
      const locationSelect = document.getElementById("location");
      const riskInput = document.getElementById("risk");
      const correctiveActionInput = document.getElementById("action");
      const durationInput = document.getElementById("duration");
      const statusSelect = document.getElementById("status");
      const branchcomment = document.getElementById("branchcomment");
      const wspcomment = document.getElementById("wspcomment");
      const branchbuttons = document.querySelectorAll('.branchbutton');
      const wspbuttons = document.querySelectorAll('.wspbutton');
  
      let branchStations = [];
      let branchDates = [];
  
        // Ù…Ù„Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
      function fillStationDetails(details) {
        locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
        locationSelect.detailsMap = {};
        details.forEach((detail, index) => {
          const option = document.createElement("option");
          option.value = index; // Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ù„ÙˆØµÙˆÙ„
          option.textContent = detail.location || "Unnamed Location";
          locationSelect.appendChild(option);
          locationSelect.detailsMap[index] = detail;
        });
      }

      locationSelect.addEventListener("change", () => {
        const selectedKey = locationSelect.value;
        if (!selectedKey) return;

        const detail = locationSelect.detailsMap[selectedKey];

        if (detail) {
          riskInput.value = detail.risk || "";
          correctiveActionInput.value = detail.correctiveAction || "";
          durationInput.value = detail.duration || "";

          let status = (detail.executionStatus || "").trim();
          switch (true) {
            case /ØªÙ…/.test(status): status = "ØªÙ…"; break;
            case /Ø¬Ø§Ø±/.test(status): status = "Ø¬Ø§Ø±Ù‰"; break;
            case /Ù„Ù…/.test(status): status = "Ù„Ù… ÙŠØªÙ…"; break;
            default: status = "";
          }
          statusSelect.value = status;
          branchcomment.value = detail.branchRemarks || "";
          wspcomment.value = detail.wspRemarks || "";

          if (detail.attachment) {
            document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
          } else {
            document.getElementById("filename").textContent = "No File";
          }
        }
      });

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹
      function fetchStations(branch) {
        if (!branch) return;

        stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';

        const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);

        fetch(url)
          .then(res => res.json())
          .then(data => {
            if (data.status === "success") {
              stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
              branchStations = data.stations;
              branchDates = data.certifiedDates;

              data.stations.forEach(station => {
                const option = document.createElement("option");
                option.value = station;
                option.textContent = station;
                stationSelect.appendChild(option);
              });
            } else {
              stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
            }
          })
          .catch(err => {
            console.error("Error fetching stations:", err);
            stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
          });
      }

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
      if (department !== "WSP") {
        branchSelect.value = department;
        branchSelect.disabled = true;
        branchcomment.disabled = false;
        wspcomment.disabled = true;
        wspbuttons.forEach(btn => btn.disabled = true);
        fetchStations(department);
      } else {
        branchSelect.disabled = false;
        branchcomment.disabled = true;
        wspcomment.disabled = false;
        branchbuttons.forEach(btn => btn.disabled = true);
        branchSelect.addEventListener("change", () => fetchStations(branchSelect.value));
      }

      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø·Ø©
      stationSelect.addEventListener("change", () => {
        const selectedStation = stationSelect.value;
        const index = branchStations.indexOf(selectedStation);
        if (index !== -1 && branchDates[index]) {
          const date = new Date(branchDates[index]);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          certifiedDateInput.value = `${year}-${month}-${day}`;
        } else certifiedDateInput.value = "";

        fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
          .then(res => res.json())
          .then(data => {
            if (data.status === "success" && data.details.length > 0) fillStationDetails(data.details);
            else {
              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
              riskInput.value = correctiveActionInput.value = durationInput.value = statusSelect.value = "";
              branchcomment.value = wspcomment.value = "";
              document.getElementById("filename").textContent = "";
            }
          })
          .catch(err => console.error("Error fetching station details:", err));
      });
    };

   
  async function updateBranch() {
    const confirmUpdate = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚ØŸ");
    if (!confirmUpdate) return;
  
    const email = document.getElementById("email").value;
    const department = document.getElementById("section").value;
    const branch = document.getElementById("branch").value;
    const station = document.getElementById("station").value;
    const location = document.getElementById("location").selectedOptions[0]?.textContent || "";
    const status = document.getElementById("status").value;
    const branchComment = document.getElementById("branchcomment").value;
    const attachmentFile = document.getElementById("attachment").files[0];
  
    if (!branch || !station || !location) {
      alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ ÙˆØ§Ù„Ù…Ø­Ø·Ø© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸");
      return;
    }
  
    let attachmentURL = "";
  
    if (attachmentFile) {
      const formData = new FormData();
      formData.append("file", attachmentFile);
      formData.append("targetURL", scriptURL + "?action=uploadFile");
  
      try {
        const uploadRes = await fetch(proxyURL, { method: "POST", body: formData });
        const uploadData = await uploadRes.json();
        if (uploadData.status === "success") {
          attachmentURL = uploadData.fileUrl;
        } else {
          alert("âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚: " + uploadData.message);
          return;
        }
      } catch (err) {
        console.error(err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚");
        return;
      }
    }
  
    const payload = {
      action: "updateBranch",
      email,
      branch,
      station,
      location,
      status,
      branchComment,
      attachment: attachmentURL
    };
  
    try {
      const res = await fetch(proxyURL, {
        method: "POST",
        body: JSON.stringify({ targetURL: scriptURL, body: payload, email: email, department: department}),
        headers: { "Content-Type": "application/json" }
      });
      const data = await res.json();
  
      if (data.status === "success") {
        alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
      } else {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: " + (data.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
      }
    } catch (err) {
      console.error(err);
      alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
    }
  }

    
    // ğŸŸ¦ ØªØ­Ø¯ÙŠØ« WSP (Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ‚Ø· + Ø§Ø¹ØªÙ…Ø§Ø¯)
    async function updateWSP() {
      const confirmUpdate = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø§Ø­Ø¸Ø§Øª WSPØŸ");
      if (!confirmUpdate) return;
    
      const email = document.getElementById("email").value;
      const branch = document.getElementById("branch").value;
      const station = document.getElementById("station").value;
      const location = document.getElementById("location").selectedOptions[0]?.textContent || "";
      const wspComment = document.getElementById("wspcomment").value;
    
      if (!branch || !station || !location) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ ÙˆØ§Ù„Ù…Ø­Ø·Ø© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸");
        return;
      }
    
      const payload = {
        action: "updateWSP",
        email,
        branch,
        station,
        location,
        wspComment
      };
    
      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();
    
        if (data.status === "success") {
          alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø§Ø­Ø¸Ø§Øª WSP Ø¨Ù†Ø¬Ø§Ø­");
    
          const approveAction = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ");
          if (approveAction) {
            const approvalPayload = {
              action: "approveAction",
              branch,
              station,
              location,
              approved: true
            };
    
            const approveRes = await fetch(scriptURL, {
              method: "POST",
              body: JSON.stringify(approvalPayload),
              headers: { "Content-Type": "application/json" }
            });
    
            const approveData = await approveRes.json();
            if (approveData.status === "success") {
              alert("âœ… ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
            } else {
              alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„");
            }
          }
    
        } else {
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
        }
      } catch (err) {
        console.error(err);
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
      }
    }

  </script>

  

</body>
</html>

























































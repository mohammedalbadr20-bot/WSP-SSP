<!DOCTYPE html>
<html>
<head>
  <title>Corrective Actions</title>
  <link rel="stylesheet" href="corr_action.css" />
</head>
<body>
  <div class="username">
    <label for="email" class="dislabel">Email</label>
    <input id="email" value="" disabled>
  </div>

  <div class="region">
    <label for="section" class="dislabel">Section</label>
    <input id="section" value="" disabled>
  </div>

  <form onsubmit="return false;">
    <h1>Corrective Actions</h1>
    <br><br>

    <div class="generalinfo">
      <div>
        <label class="infolabel">Branch</label>
        <select id="branch">
          <option value="" selected disabled>Select Branch</option>
          <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
          <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
          <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
          <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
          <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
          <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
          <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
          <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
          <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
        </select>
      </div>

      <div>
        <label class="infolabel">Station</label>
        <select id="station">
          <option value="" selected disabled>Select Station</option>
        </select>
      </div>

      <div>
        <label class="infolabel">Certified Date</label>
        <input type="date" id="certifieddate" readonly>
      </div>
    </div>

    <hr>
   
    <div class="location">
      <label>Location</label>
      <select id="location">
        <option value="">Select Location</option>
      </select>
    </div>

    <div class="risk">
      <label>Risk</label>
      <input value="" readonly id="risk"> 
    </div>

    <div class="action">
      <label>Corrective Action</label>
      <input value="" readonly id="action">
    </div>

    <div class="branchresponse">
      <div class="duration">
        <label>Duration (month)</label>
        <input type="number" value="" readonly id="duration">
      </div>

      <div>
        <label>Status</label>
        <select id="status">
          <option value="" selected disabled>Select Status</option>
          <option value="ØªÙ…">ØªÙ…</option>
          <option value="Ø¬Ø§Ø±Ù‰">Ø¬Ø§Ø±Ù‰</option>
          <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
        </select>
      </div>

      <div>
        <label>Attachment</label>
        <input id="attachment" type="file" accept="image/*">
        <span id="filename" style="margin-left:10px; color:#555;"></span>
      </div>
    </div>

    <div class="branchremark">
      <label>Branch Comment</label>
      <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
    </div>

    <div class="wspcomment">
      <label>WSP Comment</label>
      <textarea id="wspcomment" name="WSP Comments" maxlength="150"></textarea>
    </div>

    <hr>

    <div class="buttons">
      <button class="wspbutton" onclick="updateWSP()">WSP Submit</button>
      <button class="branchbutton" onclick='sendCommentsData("update")'>Branch Submit</button>
    </div>
   
  </form>
  <script>
    const proxyURL = "https://wsp-ssp.vercel.app/api/proxy";  // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ
    const scriptURL = "https://script.google.com/macros/s/AKfycbySTLSHN54meG-0lEyLUCYPz8ijSzYEHKYHZe7Syixj5uKtpc3oIgsT0G1m9hSaLArKPA/exec";
    ///
  
    window.onload = () => {
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department");
  
      document.getElementById("email").value = email || "";
      document.getElementById("section").value = department || "";
  
      const stationSelect = document.getElementById("station");
      const branchSelect = document.getElementById("branch");
      const certifiedDateInput = document.getElementById("certifieddate");
      const locationSelect = document.getElementById("location");
      const riskInput = document.getElementById("risk");
      const actionInput = document.getElementById("action");
      const durationInput = document.getElementById("duration");
      const statusSelect = document.getElementById("status");
      const branchcomment = document.getElementById("branchcomment");
      const wspcomment = document.getElementById("wspcomment");
      const branchbuttons = document.querySelectorAll('.branchbutton');
      const wspbuttons = document.querySelectorAll('.wspbutton');
  
      let branchStations = [];
      let branchDates = [];
  
        // Ù…Ù„Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
      function fillStationDetails(details) {
        locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
        locationSelect.detailsMap = {};
        details.forEach((detail, index) => {
          const option = document.createElement("option");
          option.value = index;  // Ø£Ø±Ø³Ù„ Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          option.textContent = detail.location || "Unnamed Location";
          locationSelect.appendChild(option);
          locationSelect.detailsMap[index] = detail;
        });
      }

      locationSelect.addEventListener("change", () => {
        const selectedKey = locationSelect.value;
        if (!selectedKey) return;

        const detail = locationSelect.detailsMap[selectedKey];

        if (detail) {
          riskInput.value = detail.risk || "";
          actionInput.value = detail.action || "";
          durationInput.value = detail.duration || "";

          let status = (detail.status || "").trim();
          switch (true) {
            case /ØªÙ…/.test(status): status = "ØªÙ…"; break;
            case /Ø¬Ø§Ø±/.test(status): status = "Ø¬Ø§Ø±Ù‰"; break;
            case /Ù„Ù…/.test(status): status = "Ù„Ù… ÙŠØªÙ…"; break;
            default: status = "";
          }
          statusSelect.value = status;
          branchcomment.value = detail.branchcomment || "";
          wspcomment.value = detail.wspcomment || "";

          if (detail.attachment) {
            document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
          } else {
            document.getElementById("filename").textContent = "No File";
          }
        }
      });

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹
      function fetchStations(branch) {
        if (!branch) return;

        stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';

        const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);

        fetch(url)
          .then(res => res.json())
          .then(data => {
            if (data.status === "success") {
              stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
              branchStations = data.stations;
              branchDates = data.certifiedDates;

              data.stations.forEach(station => {
                const option = document.createElement("option");
                option.value = station;
                option.textContent = station;
                stationSelect.appendChild(option);
              });
            } else {
              stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
            }
          })
          .catch(err => {
            console.error("Error fetching stations:", err);
            stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
          });
      }

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
      if (department !== "WSP") {
        branchSelect.value = department;
        branchSelect.disabled = true;
        branchcomment.disabled = false;
        wspcomment.disabled = true;
        wspbuttons.forEach(btn => btn.disabled = true);
        fetchStations(department);
      } else {
        branchSelect.disabled = false;
        branchcomment.disabled = true;
        wspcomment.disabled = false;
        branchbuttons.forEach(btn => btn.disabled = true);
        branchSelect.addEventListener("change", () => fetchStations(branchSelect.value));
      }

      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø·Ø©
      stationSelect.addEventListener("change", () => {
        const selectedStation = stationSelect.value;
        const index = branchStations.indexOf(selectedStation);
        if (index !== -1 && branchDates[index]) {
          const date = new Date(branchDates[index]);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          certifiedDateInput.value = `${year}-${month}-${day}`;
        } else certifiedDateInput.value = "";

        fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
          .then(res => res.json())
          .then(data => {
            if (data.status === "success" && data.details.length > 0) fillStationDetails(data.details);
            else {
              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
              riskInput.value = actionInput.value = durationInput.value = statusSelect.value = "";
              branchcomment.value = wspcomment.value = "";
              document.getElementById("filename").textContent = "";
            }
          })
          .catch(err => console.error("Error fetching station details:", err));
      });
    };

   
    
    
    function sendCommentsData(action) {
        const locationSelect = document.getElementById("location");
        const riskInput = document.getElementById("risk");
        const actionInput = document.getElementById("action");
        const durationInput = document.getElementById("duration");
        const statusSelect = document.getElementById("status");
        const branchcomment = document.getElementById("branchcomment");
        const wspcomment = document.getElementById("wspcomment");
        const attachmentInput = document.getElementById("attachment");
        
        const confirmUpdate = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚ØŸ");
        if (!confirmUpdate) return;
      
        const email = sessionStorage.getItem("email");
        const department = sessionStorage.getItem("department");
        const selectedKey = locationSelect.value; // Ù‡Ø°Ø§ index
        if (!selectedKey) {
          alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©!");
          return;
        }
    
        const detail = locationSelect.detailsMap[selectedKey];
        if (!detail || !detail.location) {
          alert("âš ï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­");
          return;
        }
    
        // ğŸ“ Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        const locationText = detail.location;
    
        if (action === "update" && 
            (!locationText ||
             !riskInput.value ||
             !actionInput.value ||
             !durationInput.value)) {
          alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ Ø£Ùˆ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
          return;
        }
      
              
        const formData = new URLSearchParams();
        formData.append("action", "update");  // ğŸ†• Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§
        formData.append("station", document.getElementById("station").value);
        formData.append("email", email);
        formData.append("department", department);
        formData.append("location", locationText); // âœ… Ù‡Ù†Ø§ Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        formData.append("risk", document.getElementById("risk").value);
        formData.append("action", document.getElementById("action").value);
        formData.append("duration", document.getElementById("duration").value);
        formData.append("status", document.getElementById("status").value);
        formData.append("attachment", document.getElementById("attachment").value);
        formData.append("branchcomment", document.getElementById("branchcomment").value);
        formData.append("wspcomment", document.getElementById("wspcomment").value);
      
      
        
       

        console.log("ğŸ“¤ Form Data sent to server:", formData.toString());
      
        fetch(proxyURL, {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: formData.toString()
        })
          .then(response => {
            console.log("ğŸ” Raw response object:", response);
      
            // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ JSON
            if (!response.ok) {
              console.error("âŒ Network or server error:", response.status, response.statusText);
              throw new Error(`HTTP Error: ${response.status}`);
            }
      
            // âœ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ JSON
            return response.json();
          })
          .then(result => { 
            console.log("âœ… Response JSON from server:", result);
      
            if (result.status === "unauthorized") {
              alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.");
              return;
            }
      
            if (result.result === "Updated") {
              alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            } else if (result.result === "Location not found") {
              alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø´ÙŠØª.");
            } else {
              console.warn("âš ï¸ Unexpected result object:", result);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
            }
      
            clearForm();  
            fetchData(email, department);  
          })
          .catch(error => {
            console.error("ğŸ’¥ Exception caught:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Console Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„.");
          });
      }


      function clearForm() {
        document.getElementById("location").value = "";
        document.getElementById("risk").value = "";
        document.getElementById("action").value = "";
        document.getElementById("duration").value = "";
        document.getElementById("status").value = "";
        document.getElementById("attachment").value = "";
        document.getElementById("branchcomment").value = "";
        document.getElementById("wspcomment").value = "";
        document.getElementById("filename").textContent = "";
      }
      function fetchData(email, department) {
        fetch(`${scriptURL}?action=getData&email=${encodeURIComponent(email)}&department=${encodeURIComponent(department)}`)
          .then(response => response.json())
          .then(data => {
            if (data.status === "unauthorized") {
              alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„");
              return;
            }
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          }) // ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ then Ù‡Ù†Ø§
          .catch(error => {
            console.error("Ø®Ø·Ø£:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
          });
      }


  </script>

  

</body>
</html>



































































































































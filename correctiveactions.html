<!DOCTYPE html>
<html>
<head>
  <title>Corrective Actions</title>
  <link rel="stylesheet" href="corr_action.css" />
</head>
<body>
  <div class="username">
    <label for="email" class="dislabel">Email</label>
    <input id="email" value="" disabled>
  </div>

  <div class="region">
    <label for="section" class="dislabel">Section</label>
    <input id="section" value="" disabled>
  </div>

  <form onsubmit="return false;">
    <h1>Corrective Actions</h1>
    <br><br>

    <div class="generalinfo">
      <div>
        <label class="infolabel">Branch</label>
        <select id="branch">
          <option value="" selected disabled>Select Branch</option>
          <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
          <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
          <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
          <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
          <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
          <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
          <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
          <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
          <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
        </select>
      </div>

      <div>
        <label class="infolabel">Station</label>
        <select id="station">
          <option value="" selected disabled>Select Station</option>
        </select>
      </div>

      <div>
        <label class="infolabel">Certified Date</label>
        <input type="date" id="certifieddate" readonly>
      </div>
    </div>

    <hr>
    <input type="hidden" id="rowIndex">

    <div class="location">
      <label>Location</label>
      <select id="location">
        <option value="">Select Location</option>
      </select>
    </div>

    <div class="risk">
      <label>Risk</label>
      <input value="" readonly id="risk"> 
    </div>

    <div class="action">
      <label>Corrective Action</label>
      <input value="" readonly id="action">
    </div>

    <div class="branchresponse">
      <div class="duration">
        <label>Duration (month)</label>
        <input type="number" value="" readonly id="duration">
      </div>

      <div>
        <label>Situation</label>
        <select id="situation">
          <option value="" selected disabled>Select Situation</option>
          <option value="ØªÙ…">ØªÙ…</option>
          <option value="Ø¬Ø§Ø±Ù‰">Ø¬Ø§Ø±Ù‰</option>
          <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
        </select>
      </div>

      <div>
        <label>Attachment</label>
        <input id="attachment" type="file" accept="image/*">
        <span id="filename" style="margin-left:10px; color:#555;"></span>
      </div>
    </div>

    <div class="branchremark">
      <label>Remarks</label>
      <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
    </div>

    <div class="wspcomment">
      <label>WSP Comments</label>
      <textarea id="wspcomment" name="WSP Comments" maxlength="150"></textarea>
    </div>

    <hr>

    <div class="buttons">
      <button class="wspbutton" onclick="updateWSP()">WSP Submit</button>
      <button class="branchbutton" onclick="updateBranch()">Branch Submit</button>
    </div>
    <div id="messageBox" style="margin-top:10px; color:green; font-weight:bold;"></div>

  </form>
  <script>
    const proxyURL = "https://wsp-ssp.vercel.app/api/proxy";  // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ
    const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec?action=test";
    ///https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec
  
    window.onload = () => {
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department");
  
      document.getElementById("email").value = email || "";
      document.getElementById("section").value = department || "";
  
      const stationSelect = document.getElementById("station");
      const branchSelect = document.getElementById("branch");
      const certifiedDateInput = document.getElementById("certifieddate");
      const locationSelect = document.getElementById("location");
      const riskInput = document.getElementById("risk");
      const correctiveActionInput = document.getElementById("action");
      const durationInput = document.getElementById("duration");
      const situationSelect = document.getElementById("situation");
      const branchcomment = document.getElementById("branchcomment");
      const wspcomment = document.getElementById("wspcomment");
      const branchbuttons = document.querySelectorAll('.branchbutton');
      const wspbuttons = document.querySelectorAll('.wspbutton');
  
      let branchStations = [];
      let branchDates = [];
  
      function fillStationDetails(details) {
        locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
        locationSelect.detailsMap = {};
        details.forEach((detail, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = detail.location || "Unnamed Location";
          locationSelect.appendChild(option);
          locationSelect.detailsMap[index] = detail;
        });
      }
  
      locationSelect.addEventListener("change", () => {
        const selectedIndex = locationSelect.value;
        const detail = locationSelect.detailsMap[selectedIndex];
        document.getElementById("rowIndex").value = detail?.rowIndex || selectedIndex;
  
        if (detail) {
          riskInput.value = detail.risk || "";
          correctiveActionInput.value = detail.correctiveAction || "";
          durationInput.value = detail.duration || "";
          let status = (detail.executionStatus || "").trim();
          switch (true) {
            case /ØªÙ…/.test(status): status = "ØªÙ…"; break;
            case /Ø¬Ø§Ø±/.test(status): status = "Ø¬Ø§Ø±Ù‰"; break;
            case /Ù„Ù…/.test(status): status = "Ù„Ù… ÙŠØªÙ…"; break;
            default: status = "";
          }
          situationSelect.value = status;
          branchcomment.value = detail.branchRemarks || "";
          wspcomment.value = detail.wspRemarks || "";
          if (detail.attachment) {
            document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
          } else {
            document.getElementById("filename").textContent = "No File";
          }
        }
      });
  
      function fetchStations(branch) {
          if (!branch) return;
      
          stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
      
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… scriptURL Ù…Ø¨Ø§Ø´Ø±Ø©
          const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);
      
          fetch(url)
              .then(res => res.json())
              .then(data => {
                  if (data.status === "success") {
                      stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
                      branchStations = data.stations;
                      branchDates = data.certifiedDates;
      
                      data.stations.forEach(station => {
                          const option = document.createElement("option");
                          option.value = station;
                          option.textContent = station;
                          stationSelect.appendChild(option);
                      });
                  } else {
                      stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
                  }
              })
              .catch(err => {
                  console.error("Error fetching stations:", err);
                  stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
              });
      }

  
      if (department !== "WSP") {
        branchSelect.value = department;
        branchSelect.disabled = true;
        branchcomment.disabled = false;
        wspcomment.disabled = true;
        wspbuttons.forEach(btn => btn.disabled = true);
        fetchStations(department);
      } else {
        branchSelect.disabled = false;
        branchcomment.disabled = true;
        wspcomment.disabled = false;
        branchbuttons.forEach(btn => btn.disabled = true);
        branchSelect.addEventListener("change", () => fetchStations(branchSelect.value));
      }
  
      stationSelect.addEventListener("change", () => {
        const selectedStation = stationSelect.value;
        const index = branchStations.indexOf(selectedStation);
        if (index !== -1 && branchDates[index]) {
          const date = new Date(branchDates[index]);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          certifiedDateInput.value = `${year}-${month}-${day}`;
        } else certifiedDateInput.value = "";
  
        fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
          .then(res => res.json())
          .then(data => {
            if (data.status === "success" && data.details.length > 0) fillStationDetails(data.details);
            else {
              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
              riskInput.value = correctiveActionInput.value = durationInput.value = situationSelect.value = "";
              branchcomment.value = wspcomment.value = "";
              document.getElementById("filename").textContent = "";
            }
          })
          .catch(err => console.error("Error fetching station details:", err));
      });
    };
  
   async function updateBranch() {
      // ğŸ”¹ 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØµÙØ­Ø©
      const department = sessionStorage.getItem("department");
      const station = document.getElementById("station").value;
      const email = document.getElementById("email").value;
      const rowIndex = document.getElementById("rowIndex").value;
      const executionStatus = document.getElementById("situation").value;
      const branchRemarks = document.getElementById("branchcomment").value;
      const attachment = document.getElementById("attachment").files[0];
      const branch = document.getElementById("branch").value;
    
      // ğŸ”¹ 2. ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
      const formData = new FormData();
      formData.append("action", "update");
      formData.append("station", station);
      formData.append("department", "branch");
      formData.append("email", email);
      formData.append("rowIndex", rowIndex);
      formData.append("situation", executionStatus);
      formData.append("branchcomment", branchRemarks);
      formData.append("branch", branch);
    
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ù Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯
      if (attachment) {
        formData.append("attachment", attachment);
      }
    
      try {
        // ğŸ”¹ 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const proxyURL = "https://wsp-ssp.vercel.app/api/proxy";
        const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";
    
        // Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ Ø³ÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Google Script ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        const response = await fetch(proxyURL, {
          method: "POST",
          body: formData,
          });
    
        const text = await response.text();
        console.log("Raw server response:", text);
    
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          result = { status: "error", message: text || "Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…" };
        }
    
        // ğŸ”¹ 4. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const msgBox = document.getElementById("messageBox");
        if (result.status === "success") {
          msgBox.innerText = "âœ… ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­";
          msgBox.style.color = "green";
        } else {
          msgBox.innerText = "âš ï¸ Ø®Ø·Ø£: " + (result.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹");
          msgBox.style.color = "red";
        }
    
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("messageBox").innerText = "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ùˆ ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„";
      }
    }

    
    async function updateWSP() {
      const station = document.getElementById("station").value;
      const email = document.getElementById("email").value;
      const rowIndex = document.getElementById("rowIndex").value;
      const executionStatus = document.getElementById("situation").value;
      const wspRemarks = document.getElementById("wspcomment").value;
      const attachment = document.getElementById("attachment").files[0];
      const branch = document.getElementById("branch").value;
    
      const formData = new FormData();
      formData.append("action", "update");
      formData.append("station", station);
      formData.append("department", "wsp");
      formData.append("email", email);
      formData.append("rowIndex", rowIndex);
      formData.append("situation", executionStatus);
      formData.append("wspcomment", wspRemarks);
      if (attachment) formData.append("attachment", attachment);
      formData.append("branch", branch);
    
      try {
        const response = await fetch(proxyURL, { method: "POST", body: formData });
    
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error("Invalid JSON response:", text);
          document.getElementById("messageBox").innerText = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø±Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­";
          return;
        }
    
        if (result.status === "success") {
          const approve = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ");
          if (approve) await approveAction(station, email, rowIndex, branch, executionStatus);
          document.getElementById("messageBox").innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª WSP";
        } else {
          document.getElementById("messageBox").innerText = "âš ï¸ Ø®Ø·Ø£: " + result.message;
        }
    
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("messageBox").innerText = "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
      }
    }


  
    async function approveAction(station, email, rowIndex, branch, location) {
      const formData = new FormData();
      formData.append("email", email);
      formData.append("department", "wsp");
      formData.append("station", station);
      formData.append("rowIndex", rowIndex);
      formData.append("branch", branch);
      formData.append("location", location);
  
      const response = await fetch(proxyURL + scriptURL, { method: "POST", body: formData });
      const result = await response.json();
      if (result.status === "success") alert("âœ… ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡");
      else alert("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯: " + result.message);
    }
  
    document.getElementById("attachment").addEventListener("change", function() {
      document.getElementById("filename").textContent = this.files[0]?.name || "";
    });
  </script>

  

</body>
</html>


























<!DOCTYPE html>
<html>
  <head>
    <title>Corrective Actions</title>
    <link rel="stylesheet" href="corr_action.css" />
  </head>
  <body>
    <div class="username">
      <label for="email" class="dislabel">Email</label>
      <input id="email" value="" disabled>
    </div>

    <div class="region">
      <label for="section" class="dislabel">Section</label>
      <input id="section" value="" disabled>
    </div>

    <form onsubmit="return false;">
      <h1>Corrective Actions</h1>
      <br><br>

      <div class="generalinfo">
        <div>
          <label class="infolabel">Branch</label>
          <select id="branch">
            <option value="" selected disabled>Select Branch</option>
            <option value="العدوه">العدوه</option>
            <option value="مغاغة">مغاغة</option>
            <option value="بنى مزار">بنى مزار</option>
            <option value="مطاى">مطاى</option>
            <option value="سمالوط">سمالوط</option>
            <option value="المنيا">المنيا</option>
            <option value="ابوقرقاص">ابوقرقاص</option>
            <option value="ملوى">ملوى</option>
            <option value="ديرمواس">ديرمواس</option>
          </select>
        </div>

        <div>
          <label class="infolabel">Station</label>
          <select id="station">
            <option value="" selected disabled>Select Station</option>
          </select>
        </div>

        <div>
          <label class="infolabel">Certified Date</label>
          <input type="date" id="certifieddate" disabled>
        </div>
      </div>

      <hr>

      <div class="risk">
        <label>Risk</label>
        <select>
          <option value="" selected disabled>Select Risk</option>
        </select>
      </div>

      <div class="action">
        <label>Corrective Action</label>
        <input value="" disabled id="action">
      </div>

      <div class="branchresponse">
        <div class="duration">
          <label>Duration (month)</label>
          <input type="number" value="24" disabled>
        </div>

        <div>
          <label>Situation</label>
          <select>
            <option value="" selected disabled>Select Situation</option>
            <option value="تم">تم</option>
            <option value="جارى">جارى</option>
            <option value="لم يتم">لم يتم</option>
          </select>
        </div>

        <div>
          <label>Attachment</label>
          <input type="file" accept="image/*">
        </div>
      </div>

      <div class="branchremark">
        <label>Remarks</label>
        <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
      </div>

      <div class="wspcomment">
        <label>WSP Comments</label>
        <textarea id= "wspcomment" name="WSP Comments" maxlength="150"></textarea>
      </div>

      <hr>

      <div class="buttons">
        <button>WSP Submit</button>
        <button>WSP Update</button>
        <button>Branch Submit</button>
        <button>Branch Update</button>
      </div>
    </form>
    
    <script>
      window.onload = () => {
        const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";

        const email = sessionStorage.getItem("email");
        const department = sessionStorage.getItem("department");

        document.getElementById("email").value = email || "";
        document.getElementById("section").value = department || "";

        const stationSelect = document.getElementById("station");
        const branchSelect = document.getElementById("branch");
        const wspComment = document.getElementById("wspcomment");
        const branchComment = document.getElementById("branchcomment");
        const certifiedDateInput = document.getElementById("certifieddate"); // ✅ حقل تاريخ الاعتماد

       // إذا لم يكن المستخدم من قسم WSP
        if (department !== "WSP") {
          // يتم تعيين الفرع تلقائيًا من القسم وتعطيل إمكانية تغييره
          branchSelect.value = department;
          branchSelect.disabled = true;
      
          // جلب قائمة المحطات الخاصة بالفرع من Google App Script
          fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(department)}`)
            .then(response => response.json()) // تحويل الاستجابة إلى JSON
            .then(data => {
              // عرض رسالة مؤقتة أثناء تحميل المحطات
              stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
              
              // إذا تم جلب المحطات بنجاح
              if (data.status === "success") {
                // إعادة تعيين القائمة
                stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
                
                // إضافة كل محطة كخيار في القائمة
                data.stations.forEach(station => {
                  const option = document.createElement("option");
                  option.value = station;
                  option.textContent = station;
                  stationSelect.appendChild(option);
                });
              } else {
                // في حال عدم وجود محطات
                stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
              }
            })
            .catch(error => {
              // في حال حدوث خطأ أثناء الاتصال
              console.error("Error fetching stations:", error);
              stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
            });
      
        } else {
          // إذا كان المستخدم من قسم WSP (أي يمكنه اختيار أي فرع)
          
          // إتاحة اختيار الفرع من القائمة
          branchSelect.disabled = false;
      
          // عند تغيير الفرع المختار من قبل المستخدم
          branchSelect.addEventListener("change", () => {
            const selectedBranch = branchSelect.value; // الحصول على الفرع المختار
            if (!selectedBranch) return; // التأكد من أن قيمة الفرع صالحة
      
            // عرض رسالة تحميل مؤقتة
            stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
      
            // إرسال طلب لجلب المحطات الخاصة بالفرع المختار
            fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(selectedBranch)}`)
              .then(response => response.json()) // تحويل الاستجابة إلى JSON
              .then(data => {
                if (data.status === "success") {
                  // تفريغ وإعادة بناء القائمة بالمحطات الجديدة
                  stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
                  data.stations.forEach(station => {
                    const option = document.createElement("option");
                    option.value = station;
                    option.textContent = station;
                    stationSelect.appendChild(option);
                  });
                } else {
                  // في حال لم يتم العثور على محطات
                  stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
                }
              })
              .catch(error => {
                // في حال حدوث خطأ أثناء الاتصال
                console.error("Error fetching stations:", error);
                stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
              });
          });
        }

    </script>

  


    
  </body>
</html>




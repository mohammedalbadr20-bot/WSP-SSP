<!DOCTYPE html>
<html>
  <head>
    <title>Corrective Actions</title>
    <link rel="stylesheet" href="corr_action.css" />
  </head>
  <body>
    <div class="username">
      <label for="email" class="dislabel">Email</label>
      <input id="email" value="" disabled>
    </div>

    <div class="region">
      <label for="section" class="dislabel">Section</label>
      <input id="section" value="" disabled>
    </div>

    <form onsubmit="return false;">
      <h1>Corrective Actions</h1>
      <br><br>

      <div class="generalinfo">
        <div>
          <label class="infolabel">Branch</label>
          <select id="branch">
            <option value="" selected disabled>Select Branch</option>
            <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
            <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
            <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
            <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
            <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
            <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
            <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
            <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
            <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
          </select>
        </div>

        <div>
          <label class="infolabel">Station</label>
          <select id="station">
            <option value="" selected disabled>Select Station</option>
          </select>
        </div>

        <div>
          <label class="infolabel">Certified Date</label>
          <input type="date" id="certifieddate" disabled>
        </div>
      </div>

      <hr>

      <div class="risk">
        <label>Risk</label>
        <select>
          <option value="" selected disabled>Select Risk</option>
        </select>
      </div>

      <div class="action">
        <label>Corrective Action</label>
        <input value="" disabled id="action">
      </div>

      <div class="branchresponse">
        <div class="duration">
          <label>Duration (month)</label>
          <input type="number" value="24" disabled>
        </div>

        <div>
          <label>Situation</label>
          <select>
            <option value="" selected disabled>Select Situation</option>
            <option value="ØªÙ…">ØªÙ…</option>
            <option value="Ø¬Ø§Ø±Ù‰">Ø¬Ø§Ø±Ù‰</option>
            <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
          </select>
        </div>

        <div>
          <label>Attachment</label>
          <input type="file" accept="image/*">
        </div>
      </div>

      <div class="branchremark">
        <label>Remarks</label>
        <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
      </div>

      <div class="wspcomment">
        <label>WSP Comments</label>
        <textarea id= "wspcomment" name="WSP Comments" maxlength="150"></textarea>
      </div>

      <hr>

      <div class="buttons">
        <button>WSP Submit</button>
        <button>WSP Update</button>
        <button>Branch Submit</button>
        <button>Branch Update</button>
      </div>
    </form>
    
    <script>
      window.onload = () => {
        const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";

        const email = sessionStorage.getItem("email");
        const section = sessionStorage.getItem("department");

        document.getElementById("email").value = email || "";
        document.getElementById("section").value = section || "";

        const selectedBranch = document.getElementById("branch");
        const selectedStation = document.getElementById("station");
        const wspComment = document.getElementById("wspcomment");
        const branchComment = document.getElementById("branchcomment");
        const certifiedDateInput = document.getElementById("certifieddate"); // âœ… Ø­Ù‚Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯

        // ğŸ”¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø£Ø­Ø¯ Ø§Ù„ÙØ±ÙˆØ¹
        if (section !== "WSP") {
          selectedBranch.disabled = true;
          wspComment.disabled = true;
          branchComment.disabled = false;
          selectedBranch.value = section;

          fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(section)}`)
            .then(response => response.json())
            .then(data => {
              selectedStation.innerHTML = '<option value="" disabled selected>Select Station</option>';
              data.forEach(station => {
                const option = document.createElement("option");
                // ğŸ‘‡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙƒØ§Ø¦Ù†Ø§Øª ÙÙŠÙ‡Ø§ name ÙˆcertifiedDate
                if (typeof station === "object") {
                  option.value = station.name;
                  option.textContent = station.name;
                } else {
                  option.value = station;
                  option.textContent = station;
                }
                selectedStation.appendChild(option);
              });

              // âœ… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø·Ø©ØŒ Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§ Ø¥Ù† ÙˆØ¬Ø¯
              selectedStation.addEventListener("change", () => {
                const selected = data.find(st =>
                  (st.name || st) === selectedStation.value
                );
                if (selected && selected.certifiedDate) {
                  certifiedDateInput.value = selected.certifiedDate;
                } else {
                  certifiedDateInput.value = "";
                }
              });
            })
            .catch(error => console.error("Error fetching stations:", error));

        } else {
          // ğŸ”¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø³Ù… WSP
          selectedBranch.disabled = false;
          wspComment.disabled = false;
          branchComment.disabled = true;

          selectedBranch.addEventListener("change", () => {
            const branch = selectedBranch.value;
            if (!branch) return;

            selectedStation.innerHTML = '<option value="" disabled selected>Loading Stations...</option>';

            fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`)
              .then(response => response.json())
              .then(data => {
                selectedStation.innerHTML = '<option value="" disabled selected>Select Station</option>';
                const stations = data.stations || data;
                if (Array.isArray(stations)) {
                  stations.forEach(station => {
                    const option = document.createElement("option");
                    if (typeof station === "object") {
                      option.value = station.name;
                      option.textContent = station.name;
                    } else {
                      option.value = station;
                      option.textContent = station;
                    }
                    selectedStation.appendChild(option);
                  });

                  // âœ… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø·Ø©ØŒ Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§ Ø¥Ù† ÙˆØ¬Ø¯
                  selectedStation.addEventListener("change", () => {
                    const selected = stations.find(st =>
                      (st.name || st) === selectedStation.value
                    );
                    if (selected && selected.certifiedDate) {
                      certifiedDateInput.value = selected.certifiedDate;
                    } else {
                      certifiedDateInput.value = "";
                    }
                  });
                } else {
                  selectedStation.innerHTML = '<option value="" disabled selected>Not found</option>';
                }
              })
              .catch(error => {
                console.error("Error fetching stations:", error);
                selectedStation.innerHTML = '<option value="" disabled selected>Connection Error</option>';
              });
          });
        }
      };
      // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø·Ø© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø·Ø©
      function fetchStationDetails() {
          var station = document.getElementById('station').value; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
          google.script.run.withSuccessHandler(updateStationDetails).getStationDetails(station); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø·Ø©
      }

      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
      function updateStationDetails(data) {
          if (data.status === "success") {
              // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
              var detail = data.details[0]; // Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† ØªÙØ§ØµÙŠÙ„
              document.getElementById('risk').value = detail.risk;
              document.getElementById('action').value = detail.correctiveAction;
              document.getElementById('duration').value = detail.duration;
              document.getElementById('situation').value = detail.executionStatus;
              document.getElementById('remarks').value = detail.branchRemarks;
              document.getElementById('wspComments').value = detail.wspRemarks;

              // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ ØªØ¹Ø¨Ø¦ØªÙ‡Ø§
              document.getElementById('stationDetails').style.display = 'block';
          } else {
              alert('Error retrieving station details: ' + data.message);
          }
      }

    </script>

  


    
  </body>
</html>


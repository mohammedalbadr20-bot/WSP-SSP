<!DOCTYPE html>
<html>
<head>
  <title>Corrective Actions</title>
  <link rel="stylesheet" href="corr_action.css" />
</head>
<body>
  <div class="username">
    <label for="email" class="dislabel">Email</label>
    <input id="email" value="" disabled>
  </div>

  <div class="region">
    <label for="section" class="dislabel">Section</label>
    <input id="section" value="" disabled>
  </div>

  <form onsubmit="return false;">
    <h1>Corrective Actions</h1>
    <br><br>

    <div class="generalinfo">
      <div>
        <label class="infolabel">Branch</label>
        <select id="branch">
          <option value="" selected disabled>Select Branch</option>
          <option value="العدوه">العدوه</option>
          <option value="مغاغة">مغاغة</option>
          <option value="بنى مزار">بنى مزار</option>
          <option value="مطاى">مطاى</option>
          <option value="سمالوط">سمالوط</option>
          <option value="المنيا">المنيا</option>
          <option value="ابوقرقاص">ابوقرقاص</option>
          <option value="ملوى">ملوى</option>
          <option value="ديرمواس">ديرمواس</option>
        </select>
      </div>

      <div>
        <label class="infolabel">Station</label>
        <select id="station">
          <option value="" selected disabled>Select Station</option>
        </select>
      </div>

      <div>
        <label class="infolabel">Certified Date</label>
        <input type="date" id="certifieddate" readonly>
      </div>
    </div>

    <hr>
    <input type="hidden" id="rowIndex">

    <div class="location">
      <label>Location</label>
      <select id="location">
        <option value="">Select Location</option>
      </select>
    </div>

    <div class="risk">
      <label>Risk</label>
      <input value="" readonly id="risk"> 
    </div>

    <div class="action">
      <label>Corrective Action</label>
      <input value="" readonly id="action">
    </div>

    <div class="branchresponse">
      <div class="duration">
        <label>Duration (month)</label>
        <input type="number" value="" readonly id="duration">
      </div>

      <div>
        <label>Situation</label>
        <select id="situation">
          <option value="" selected disabled>Select Situation</option>
          <option value="تم">تم</option>
          <option value="جارى">جارى</option>
          <option value="لم يتم">لم يتم</option>
        </select>
      </div>

      <div>
        <label>Attachment</label>
        <input id="attachment" type="file" accept="image/*">
        <span id="filename" style="margin-left:10px; color:#555;"></span>
      </div>
    </div>

    <div class="branchremark">
      <label>Remarks</label>
      <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
    </div>

    <div class="wspcomment">
      <label>WSP Comments</label>
      <textarea id="wspcomment" name="WSP Comments" maxlength="150"></textarea>
    </div>

    <hr>

    <div class="buttons">
      <button class="wspbutton" onclick="updateWSP()">WSP Submit</button>
      <button class="branchbutton" onclick="updateBranch()">Branch Submit</button>
    </div>
    <div id="messageBox" style="margin-top:10px; color:green; font-weight:bold;"></div>

  </form>
  <script>
    const proxyURL = "https://wsp-ssp.vercel.app/api/proxy";  // رابط البروكسي
    const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";
  
    window.onload = () => {
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department");
  
      document.getElementById("email").value = email || "";
      document.getElementById("section").value = department || "";
  
      const stationSelect = document.getElementById("station");
      const branchSelect = document.getElementById("branch");
      const certifiedDateInput = document.getElementById("certifieddate");
      const locationSelect = document.getElementById("location");
      const riskInput = document.getElementById("risk");
      const correctiveActionInput = document.getElementById("action");
      const durationInput = document.getElementById("duration");
      const situationSelect = document.getElementById("situation");
      const branchcomment = document.getElementById("branchcomment");
      const wspcomment = document.getElementById("wspcomment");
      const branchbuttons = document.querySelectorAll('.branchbutton');
      const wspbuttons = document.querySelectorAll('.wspbutton');
  
      let branchStations = [];
      let branchDates = [];
  
      function fillStationDetails(details) {
        locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
        locationSelect.detailsMap = {};
        details.forEach((detail, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = detail.location || "Unnamed Location";
          locationSelect.appendChild(option);
          locationSelect.detailsMap[index] = detail;
        });
      }
  
      locationSelect.addEventListener("change", () => {
        const selectedIndex = locationSelect.value;
        const detail = locationSelect.detailsMap[selectedIndex];
        document.getElementById("rowIndex").value = detail?.rowIndex || selectedIndex;
  
        if (detail) {
          riskInput.value = detail.risk || "";
          correctiveActionInput.value = detail.correctiveAction || "";
          durationInput.value = detail.duration || "";
          let status = (detail.executionStatus || "").trim();
          switch (true) {
            case /تم/.test(status): status = "تم"; break;
            case /جار/.test(status): status = "جارى"; break;
            case /لم/.test(status): status = "لم يتم"; break;
            default: status = "";
          }
          situationSelect.value = status;
          branchcomment.value = detail.branchRemarks || "";
          wspcomment.value = detail.wspRemarks || "";
          if (detail.attachment) {
            document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
          } else {
            document.getElementById("filename").textContent = "No File";
          }
        }
      });
  
      function fetchStations(branch) {
          if (!branch) return;
      
          stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
      
          // استخدام scriptURL مباشرة
          const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);
      
          fetch(url)
              .then(res => res.json())
              .then(data => {
                  if (data.status === "success") {
                      stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
                      branchStations = data.stations;
                      branchDates = data.certifiedDates;
      
                      data.stations.forEach(station => {
                          const option = document.createElement("option");
                          option.value = station;
                          option.textContent = station;
                          stationSelect.appendChild(option);
                      });
                  } else {
                      stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
                  }
              })
              .catch(err => {
                  console.error("Error fetching stations:", err);
                  stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
              });
      }

  
      if (department !== "WSP") {
        branchSelect.value = department;
        branchSelect.disabled = true;
        branchcomment.disabled = false;
        wspcomment.disabled = true;
        wspbuttons.forEach(btn => btn.disabled = true);
        fetchStations(department);
      } else {
        branchSelect.disabled = false;
        branchcomment.disabled = true;
        wspcomment.disabled = false;
        branchbuttons.forEach(btn => btn.disabled = true);
        branchSelect.addEventListener("change", () => fetchStations(branchSelect.value));
      }
  
      stationSelect.addEventListener("change", () => {
        const selectedStation = stationSelect.value;
        const index = branchStations.indexOf(selectedStation);
        if (index !== -1 && branchDates[index]) {
          const date = new Date(branchDates[index]);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          certifiedDateInput.value = `${year}-${month}-${day}`;
        } else certifiedDateInput.value = "";
  
        fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
          .then(res => res.json())
          .then(data => {
            if (data.status === "success" && data.details.length > 0) fillStationDetails(data.details);
            else {
              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
              riskInput.value = correctiveActionInput.value = durationInput.value = situationSelect.value = "";
              branchcomment.value = wspcomment.value = "";
              document.getElementById("filename").textContent = "";
            }
          })
          .catch(err => console.error("Error fetching station details:", err));
      });
    };
  
   async function updateBranch() {
      const department = sessionStorage.getItem("department");;
      const station = document.getElementById("station").value;
      const email = document.getElementById("email").value;
      const rowIndex = document.getElementById("rowIndex").value;
      const executionStatus = document.getElementById("situation").value;
      const branchRemarks = document.getElementById("branchcomment").value;
      const attachment = document.getElementById("attachment").files[0];
      const branch = document.getElementById("branch").value;
    
      const formData = new FormData();
      formData.append("action", "update");
      formData.append("station", station);
      formData.append("department", "branch");
      formData.append("email", email);
      formData.append("rowIndex", rowIndex);
      formData.append("situation", executionStatus);
      formData.append("branchcomment", branchRemarks);
      if (attachment) formData.append("attachment", attachment);
      formData.append("branch", branch);
    
      try {
        console.log("Email sent:", email, "Department sent:", department);

        const response = await fetch("https://cors-proxy-vercel-ms5e.vercel.app/api/proxy", {
          method: "POST",
          body: new URLSearchParams({
            action: "update",
            station,
            department: "branch",
            email,
            rowIndex,
            situation: executionStatus,
            branchcomment: branchRemarks,
            branch
          })
        });

        const text = await response.text();
        let result;
        
        try {
          result = JSON.parse(text);
        } catch (e) {
          result = { status: "error", message: text || "استجابة غير صالحة من السيرفر" };
        }
    
        // عرض النتيجة في messageBox
        if (result.status === "success") {
          document.getElementById("messageBox").innerText = "✅ تم حفظ تعديلات الفرع";
        } else {
          document.getElementById("messageBox").innerText = "⚠️ خطأ: " + (result.message || "حدث خطأ غير متوقع");
        }

    
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("messageBox").innerText = "⚠️ فشل الاتصال بالخادم";
      }
    }
    
    async function updateWSP() {
      const station = document.getElementById("station").value;
      const email = document.getElementById("email").value;
      const rowIndex = document.getElementById("rowIndex").value;
      const executionStatus = document.getElementById("situation").value;
      const wspRemarks = document.getElementById("wspcomment").value;
      const attachment = document.getElementById("attachment").files[0];
      const branch = document.getElementById("branch").value;
    
      const formData = new FormData();
      formData.append("action", "update");
      formData.append("station", station);
      formData.append("department", "wsp");
      formData.append("email", email);
      formData.append("rowIndex", rowIndex);
      formData.append("situation", executionStatus);
      formData.append("wspcomment", wspRemarks);
      if (attachment) formData.append("attachment", attachment);
      formData.append("branch", branch);
    
      try {
        const response = await fetch(proxyURL, { method: "POST", body: formData });
    
        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error("Invalid JSON response:", text);
          document.getElementById("messageBox").innerText = "⚠️ خطأ في الاتصال بالخادم أو الرد غير صالح";
          return;
        }
    
        if (result.status === "success") {
          const approve = confirm("هل تريد اعتماد انتهاء الإجراء؟");
          if (approve) await approveAction(station, email, rowIndex, branch, executionStatus);
          document.getElementById("messageBox").innerText = "✅ تم تحديث بيانات WSP";
        } else {
          document.getElementById("messageBox").innerText = "⚠️ خطأ: " + result.message;
        }
    
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("messageBox").innerText = "⚠️ فشل الاتصال بالخادم";
      }
    }


  
    async function approveAction(station, email, rowIndex, branch, location) {
      const formData = new FormData();
      formData.append("email", email);
      formData.append("department", "wsp");
      formData.append("station", station);
      formData.append("rowIndex", rowIndex);
      formData.append("branch", branch);
      formData.append("location", location);
  
      const response = await fetch(proxyURL + scriptURL, { method: "POST", body: formData });
      const result = await response.json();
      if (result.status === "success") alert("✅ تم اعتماد انتهاء الإجراء");
      else alert("⚠️ فشل الاعتماد: " + result.message);
    }
  
    document.getElementById("attachment").addEventListener("change", function() {
      document.getElementById("filename").textContent = this.files[0]?.name || "";
    });
  </script>

  

</body>
</html>





















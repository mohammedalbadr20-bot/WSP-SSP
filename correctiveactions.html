<!DOCTYPE html>
<html>
  <head>
    <title>Corrective Actions</title>
    <link rel="stylesheet" href="corr_action.css" />
  </head>
  <body>
    <div class="username">
      <label for="email" class="dislabel">Email</label>
      <input id="email" value="" disabled>
    </div>

    <div class="region">
      <label for="section" class="dislabel">Section</label>
      <input id="section" value="" disabled>
    </div>

    <form onsubmit="return false;">
      <h1>Corrective Actions</h1>
      <br><br>

      <div class="generalinfo">
        <div>
          <label class="infolabel">Branch</label>
          <select id="branch">
            <option value="" selected disabled>Select Branch</option>
            <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
            <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
            <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
            <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
            <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
            <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
            <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
            <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
            <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
          </select>
        </div>

        <div>
          <label class="infolabel">Station</label>
          <select id="station">
            <option value="" selected disabled>Select Station</option>
          </select>
        </div>

        <div>
          <label class="infolabel">Certified Date</label>
          <input type="date" id="certifieddate" disabled>
        </div>
      </div>

      <hr>

      <div class="location">
        <label>Location</label>
        <select id="location">
          <option value="">Select Location</option>
        </select>
      </div>

      <div class="risk">
        <label>Risk</label>
        <select id="risk">
          <option value="" selected disabled>Select Risk</option>
        </select>
      </div>

      <div class="action">
        <label>Corrective Action</label>
        <input value="" disabled id="action">
      </div>

      <div class="branchresponse">
        <div class="duration">
          <label>Duration (month)</label>
          <input type="number" value="" disabled id="duration">
        </div>

        <div>
          <label>Situation</label>
          <select id="situation">
            <option value="" selected disabled>Select Situation</option>
            <option value="ØªÙ…">ØªÙ…</option>
            <option value="Ø¬Ø§Ø±Ù‰">Ø¬Ø§Ø±Ù‰</option>
            <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
          </select>
        </div>

        <div>
          <label>Attachment</label>
          <input id="attachment" type="file" accept="image/*">
          <span id="filename" style="margin-left:10px; color:#555;"></span>
        </div>
      </div>

      <div class="branchremark">
        <label>Remarks</label>
        <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
      </div>

      <div class="wspcomment">
        <label>WSP Comments</label>
        <textarea id="wspcomment" name="WSP Comments" maxlength="150"></textarea>
      </div>

      <hr>

      <div class="buttons">
        <button class="wspbutton">WSP Submit</button>
        <button class="wspbutton">WSP Update</button>
        <button class="branchbutton">Branch Submit</button>
        <button class="branchbutton">Branch Update</button>
      </div>
    </form>
    
    <script>
         window.onload = () => {
          const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";
      
          const email = sessionStorage.getItem("email");
          const department = sessionStorage.getItem("department");
      
          document.getElementById("email").value = email || "";
          document.getElementById("section").value = department || "";
      
          const stationSelect = document.getElementById("station");
          const branchSelect = document.getElementById("branch");
          const certifiedDateInput = document.getElementById("certifieddate");
          
          const locationSelect = document.getElementById("location");
          const riskSelect = document.getElementById("risk");
          const correctiveActionInput = document.getElementById("action");
          const durationInput = document.getElementById("duration");
          const situationSelect = document.getElementById("situation");
          const branchcomment = document.getElementById("branchcomment");
          const wspcomment = document.getElementById("wspcomment");
          const branchbuttons = document.querySelectorAll('.branchbutton');
          const wspbuttons = document.querySelectorAll('.wspbutton');
           

      
          let branchStations = [];      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª
          let branchDates = [];         // Ù‚Ø§Ø¦Ù…Ø© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
          
          let locationDataMap = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ù…ÙˆÙ‚Ø¹

          function fillStationDetails(details) {
            const locationSelect = document.getElementById("location");
          
            locationSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</option>';
            locationDataMap = {}; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
          
            details.forEach(item => {
              if (item.location) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ Ø£Ø¶ÙÙ‡
                if (!locationDataMap[item.location]) {
                  locationDataMap[item.location] = {
                    risks: new Set(),
                    correctiveActions: new Set(),
                    situations: new Set(),
                    branchComments: new Set(),
                    wspComments: new Set()
                  };
          
                  const optionLoc = document.createElement("option");
                  optionLoc.value = item.location;
                  optionLoc.text = item.location;
                  locationSelect.add(optionLoc);
                }
          
                if (item.risk) locationDataMap[item.location].risks.add(item.risk);
                if (item.correctiveAction) locationDataMap[item.location].correctiveActions.add(item.correctiveAction);
                if (item.executionStatus) locationDataMap[item.location].situations.add(item.executionStatus);
                if (item.branchRemarks) locationDataMap[item.location].branchComments.add(item.branchRemarks);
                if (item.wspRemarks) locationDataMap[item.location].wspComments.add(item.wspRemarks);
              }
            });
          }
          document.getElementById("location").addEventListener("change", (e) => {
          const selectedLocation = e.target.value;
      
          const riskSelect = document.getElementById("risk");
          const correctiveActionInput = document.getElementById("action");
          const situationSelect = document.getElementById("situation");
          const branchcomment = document.getElementById("branchcomment");
          const wspcomment = document.getElementById("wspcomment");
      
          // ØªÙØ±ÙŠØº Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          riskSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø§Ø·Ø±</option>';
          situationSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹</option>';
          correctiveActionInput.value = "";
          branchcomment.value = "";
          wspcomment.value = "";
      
          if (locationDataMap[selectedLocation]) {
            const data = locationDataMap[selectedLocation];
      
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±
            data.risks.forEach(risk => {
              const option = document.createElement("option");
              option.value = risk;
              option.text = risk;
              riskSelect.add(option);
            });
      
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙˆØ¶Ø¹
            data.situations.forEach(status => {
              const option = document.createElement("option");
              option.value = status;
              option.text = status;
              situationSelect.add(option);
            });
      
            // ØªØ¹Ø¨Ø¦Ø© Ø£ÙˆÙ„ Ø¥Ø¬Ø±Ø§Ø¡ ØªØµØ­ÙŠØ­ÙŠ
            const correctiveActionsArray = Array.from(data.correctiveActions);
            if (correctiveActionsArray.length > 0) correctiveActionInput.value = correctiveActionsArray[0];
      
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
            const branchCommentsArray = Array.from(data.branchComments);
            if (branchCommentsArray.length > 0) branchcomment.value = branchCommentsArray[0];
      
            const wspCommentsArray = Array.from(data.wspComments);
            if (wspCommentsArray.length > 0) wspcomment.value = wspCommentsArray[0];
          }
        });
      };
      
          // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙˆØªÙˆØ§Ø±ÙŠØ®Ù‡Ø§
          function fetchStations(branch) {
            if (!branch) return;
      
            stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
      
            fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`)
              .then(response => response.json())
              .then(data => {
                if (data.status === "success") {
                  stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
                  branchStations = data.stations;
                  branchDates = data.certifiedDates;
      
                  data.stations.forEach((station, index) => {
                    const option = document.createElement("option");
                    option.value = station;
                    option.textContent = station;
                    stationSelect.appendChild(option);
                  });
                } else {
                  stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
                }
              })
              .catch(error => {
                console.error("Error fetching stations:", error);
                stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
              });
          }
      
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† WSP
          if (department !== "WSP") {
            branchSelect.value = department;
            branchSelect.disabled = true;
            branchcomment.disabled=false;
            wspcomment.disabled=true;
            wspbuttons.forEach(button => button.disabled = true);
            
            fetchStations(department);
          } else {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù† WSP ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹
            branchSelect.disabled = false;
            branchcomment.disabled=true;
            wspcomment.disabled=false;
            branchbuttons.forEach(button => button.disabled = true);
            
            branchSelect.addEventListener("change", () => {
              fetchStations(branchSelect.value);
            });
          }
      
          // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø·Ø©ØŒ ÙŠØªÙ… Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚
          stationSelect.addEventListener("change", () => {
            const selectedStation = stationSelect.value;
            const index = branchStations.indexOf(selectedStation);
      
            if (index !== -1 && branchDates[index]) {
              // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Google Sheet Ø¥Ù„Ù‰ ØµÙŠØºØ© YYYY-MM-DD
              const date = new Date(branchDates[index]);
              const formattedDate = date.toISOString().split("T")[0];
              certifiedDateInput.value = formattedDate;
            } else {
              certifiedDateInput.value = "";
            }
           // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø·Ø©
            fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(selectedStation)}`)
              .then(res => res.json())
              .then(data => {
                console.log("ğŸ“¦ Station Data:", data); // â† Ø§Ø·Ø¨Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ù€Console
                
                if (data.status === "success" && data.details.length > 0) {
                  const details = data.details; // ÙƒÙ„Ù‡Ø§ ØªÙØ§ØµÙŠÙ„
                  fillStationDetails(details);  // Ù†Ù…Ù„Ø£ Ø®ÙŠØ§Ø±Ø§Øª location, risk, situation
                  const detail = data.details[0];
                  document.getElementById("location").value = detail.location || "";
                  document.getElementById("risk").value = detail.risk || "";
                  document.getElementById("action").value = detail.correctiveAction || "";
                  document.getElementById("duration").value = detail.duration || "";
                  document.getElementById("situation").value = detail.executionStatus || "";
                  document.getElementById("filename").textContent = detail.attachment ? detail.attachment : "";
                  document.getElementById("branchcomment").value = detail.branchRemarks || "";
                  document.getElementById("wspcomment").value = detail.wspRemarks || "";
                }
              })
              .catch(err => console.error("Error fetching station details:", err));
          });
        };
     


    </script>
  </body>
</html>

























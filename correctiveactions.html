<!DOCTYPE html>
<html>
  <head>
    <title>Corrective Actions</title>
    <link rel="stylesheet" href="corr_action.css" />
  </head>
  <body>
    <div class="username">
      <label for="email" class="dislabel">Email</label>
      <input id="email" value="" disabled>
    </div>

    <div class="region">
      <label for="section" class="dislabel">Section</label>
      <input id="section" value="" disabled>
    </div>

    <form onsubmit="return false;">
      <h1>Corrective Actions</h1>
      <br><br>

      <div class="generalinfo">
        <div>
          <label class="infolabel">Branch</label>
          <select id="branch">
            <option value="" selected disabled>Select Branch</option>
            <option value="العدوه">العدوه</option>
            <option value="مغاغة">مغاغة</option>
            <option value="بنى مزار">بنى مزار</option>
            <option value="مطاى">مطاى</option>
            <option value="سمالوط">سمالوط</option>
            <option value="المنيا">المنيا</option>
            <option value="ابوقرقاص">ابوقرقاص</option>
            <option value="ملوى">ملوى</option>
            <option value="ديرمواس">ديرمواس</option>
          </select>
        </div>

        <div>
          <label class="infolabel">Station</label>
          <select id="station" onchange="fetchStationDetails()">
            <option value="" selected disabled>Select Station</option>
          </select>
        </div>

        <div>
          <label class="infolabel">Certified Date</label>
          <input type="date" id="certifieddate" disabled>
        </div>
      </div>

      <hr>

      <!-- حاوية تفاصيل المحطة -->
      <div id="stationDetails" style="display:none;">
        <div class="risk">
          <label>Risk</label>
          <select id="risk">
            <option value="" selected disabled>Select Risk</option>
          </select>
        </div>

        <div class="action">
          <label>Corrective Action</label>
          <input value="" disabled id="action">
        </div>

        <div class="branchresponse">
          <div class="duration">
            <label>Duration (month)</label>
            <input type="number" value="24" disabled id="duration">
          </div>

          <div>
            <label>Situation</label>
            <select id="situation">
              <option value="" selected disabled>Select Situation</option>
              <option value="تم">تم</option>
              <option value="جارى">جارى</option>
              <option value="لم يتم">لم يتم</option>
            </select>
          </div>

          <div>
            <label>Attachment</label>
            <input type="file" accept="image/*">
          </div>
        </div>

        <div class="branchremark">
          <label>Remarks</label>
          <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
        </div>

        <div class="wspcomment">
          <label>WSP Comments</label>
          <textarea id="wspcomment" name="WSP Comments" maxlength="150"></textarea>
        </div>
      </div>

      <hr>

      <div class="buttons">
        <button>WSP Submit</button>
        <button>WSP Update</button>
        <button>Branch Submit</button>
        <button>Branch Update</button>
      </div>
    </form>
    
    <script>
      const scriptURL = "https://script.google.com/macros/s/AKfycbwm-xoojxIaAJ8-cLLIRFAthMHT1FFWS8w0gHtf6xlhU5xP3eqB47CQucqea4GDEm0Zlw/exec";
      const email = sessionStorage.getItem("email");
      const section = sessionStorage.getItem("department");

      document.getElementById("email").value = email || "";
      document.getElementById("section").value = section || "";

      const selectedBranch = document.getElementById("branch");
      const selectedStation = document.getElementById("station");
      const wspComment = document.getElementById("wspcomment");
      const branchComment = document.getElementById("branchcomment");
      const certifiedDateInput = document.getElementById("certifieddate");

      // دالة لملء المحطات
      function populateStations(data) {
        selectedStation.innerHTML = '<option value="" disabled selected>Select Station</option>';
        if (!data.stations) return;

        data.stations.forEach((station, idx) => {
          const option = document.createElement("option");
          option.value = station;
          option.textContent = station;
          option.dataset.certifiedDate = data.certifiedDates ? data.certifiedDates[idx] : "";
          selectedStation.appendChild(option);
        });

        selectedStation.addEventListener("change", () => {
          const selectedOption = selectedStation.selectedOptions[0];
          certifiedDateInput.value = selectedOption.dataset.certifiedDate || "";
          fetchStationDetails();
        });
      }

      // جلب المحطات عند تحميل الصفحة أو اختيار الفرع
      function fetchStations(branch) {
        if (!branch) return;

        fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`)
          .then(resp => resp.json())
          .then(data => populateStations(data))
          .catch(err => console.error("Error fetching stations:", err));
      }

      // تحميل المحطات تلقائيًا إذا كان المستخدم ليس WSP
      if (section !== "WSP") {
        selectedBranch.disabled = true;
        selectedBranch.value = section;
        branchComment.disabled = false;
        wspComment.disabled = true;

        fetchStations(section);
      } else {
        selectedBranch.disabled = false;
        branchComment.disabled = true;
        wspComment.disabled = false;

        selectedBranch.addEventListener("change", () => fetchStations(selectedBranch.value));
      }
    </script>
     

     


